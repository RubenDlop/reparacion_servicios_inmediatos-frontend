import { register } from 'swiper/element/bundle';
register();

import './app.css';
import App from './App.svelte';
import { mount } from 'svelte';   

const app = mount(App, {        
  target: document.getElementById('app'),
}); 

export default app;
  import { register } from 'swiper/element/bundle';
register();

import './app.css';
import App from './App.svelte';
import { mount } from 'svelte';   

const app = mount(App, {        
  target: document.getElementById('app'),
}); 

export default app;
  <script>
  import Router, { location } from 'svelte-spa-router';
  import { routes } from './routes/index.js';
  import Nav from './lib/nav/Nav.svelte';
  import Footer from './lib/footer/Footer.svelte';
  import { onMount } from 'svelte';
  import { checkAuth, logoutAndClear } from './lib/stores/auth.js';

  function handleLogout() { logoutAndClear(); }

  onMount(() => {
    checkAuth(); // verifica token al cargar la app
  });
</script>

<!-- ‚úÖ SOLO un nav -->
<Nav logoSrc="/logo.png" brand="RIB" on:logout={handleLogout} />

<main>
  {#key $location}
    <Router {routes} useHash={false} restoreScrollState={true} />
  {/key}
</main>

<Footer brand="RIB" logoSrc="/logo.png" />
// src/nav/routes.js
import { wrap } from 'svelte-spa-router/wrap';
import { requireAuth, onlyGuests, session } from '../lib/stores/auth.js';
import { get } from 'svelte/store';

// P√∫blicas / marketing
import Home from '../lib/pages/Home.svelte';
import ServicesPage from '../lib/pages/ServicesPage.svelte';
import PreciosPage from '../lib/pages/PreciosPage.svelte';
import ContactoPage from '../lib/pages/ContactoPage.svelte';
import Nosotros from '../lib/pages/Nosotros.svelte';
import FAQ from '../lib/pages/FAQ.svelte';
import Soporte from '../lib/pages/Soporte.svelte';
import Estado from '../lib/pages/Estado.svelte';
import Privacidad from '../lib/pages/Privacidad.svelte';
import Terminos from '../lib/pages/Terminos.svelte';
import NotFound from '../lib/pages/NotFound.svelte';

// √Årea app general
import DashboardPage from '../lib/pages/DashboardPage.svelte';
import LoginPage from '../lib/pages/login.svelte';
import RegistroPage from '../lib/pages/RegistroPage.svelte';
import RecuperarPage from '../lib/pages/RecuperarPage.svelte';
import SolicitarPage from '../lib/pages/SolicitarPage.svelte';
import SoyTecnico from '../lib/pages/SoyTecnico.svelte';
import MisTrabajos from '../lib/pages/MisTrabajos.svelte';
import SolicitudDetalle from '../lib/pages/SolicitudDetalle.svelte';
import Cuenta from '../lib/pages/Cuenta.svelte';

// **NUEVAS p√°ginas para el parcial**
import PrincipalPage from '../lib/pages/Principal.svelte';   // Principal (informaci√≥n del proyecto)
import ReportePage from '../lib/pages/Reporte.svelte';       // Reporte (form + tabla; no funcional)

// Admin
import AdminPage from '../lib/pages/Admin.svelte';           // Dashboard Admin (puede ser tu Admin.svelte)

// (Opcional si vas a separar vistas de admin por archivo)
import RolesPage from '../lib/pages/admin/Roles.svelte';     // CRUD Roles & Permisos (soft-delete)
import UsuariosPage from '../lib/pages/admin/Usuarios.svelte'; // CRUD Usuarios con rol (soft-delete)

export const NAV_LINKS = [
  { href: '/',          label: 'Inicio' },
  { href: '/servicios', label: 'Servicios' },
  { href: '/precios',   label: 'Precios' },
  { href: '/contacto',  label: 'Contacto' },
  { href: '/principal', label: 'Principal' },
  { href: '/reporte',   label: 'Reporte' },
  { href: '/login',     label: 'Iniciar sesi√≥n' },
];
function requireAdmin(detail) {
  const s = get(session);
  const next = encodeURIComponent(detail?.location || '/admin');
  if (!s?.user) return `/login?next=${next}`; 
  if (s.user.is_superuser || s.user?.rol?.nombre === 'Admin') return true;
  return '/dashboard'; // autenticado pero no admin
}

export const routes = {
  // P√∫blicas
  '/': Home,
  '/servicios': ServicesPage,
  '/precios': PreciosPage,
  '/contacto': ContactoPage,
  '/nosotros':   Nosotros,
  '/faq':        FAQ,
  '/soporte':    Soporte,
  '/estado':     Estado,
  '/privacidad': Privacidad,
  '/terminos':   Terminos,

  // Auth
  '/login':     wrap({ component: LoginPage,     conditions: [onlyGuests] }),
  '/registro':  wrap({ component: RegistroPage,  conditions: [onlyGuests] }),
  '/recuperar': wrap({ component: RecuperarPage, conditions: [onlyGuests] }),

  // App general (protegidas)
  '/dashboard':       wrap({ component: DashboardPage,   conditions: [requireAuth] }),
  '/soy-tecnico':     wrap({ component: SoyTecnico,      conditions: [requireAuth] }),
  '/perfil-tecnico':  wrap({ component: SoyTecnico,      conditions: [requireAuth] }),
  '/mis-trabajos':    wrap({ component: MisTrabajos,     conditions: [requireAuth] }),
  '/solicitar':       wrap({ component: SolicitarPage,   conditions: [requireAuth] }),
  '/cuenta':          wrap({ component: Cuenta,          conditions: [requireAuth] }),

  // Detalle protegido
  '/solicitud/:id':   wrap({ component: SolicitudDetalle, conditions: [requireAuth] }),

  // **NUEVAS p√°ginas requeridas por el parcial**
  '/principal': PrincipalPage, // p√∫blica (puedes protegerla si quieres)
  '/reporte':   ReportePage,   // p√∫blica; el formulario NO necesita estar funcional

  // Admin
  '/admin':            wrap({ component: AdminPage,    conditions: [requireAdmin] }),
  '/admin/roles':      wrap({ component: RolesPage,    conditions: [requireAdmin] }),
  '/admin/usuarios':   wrap({ component: UsuariosPage, conditions: [requireAdmin] }),
  '/admin/roles': wrap({ component: RolesPage, conditions: [requireAdmin] }),


  // 404
  '*': NotFound,
};
// src/lib/utils/formatters.js
export const timeAgo = (s) => {
  if (!s) return '‚Äî';
  const ms = Date.now() - new Date(s).getTime();
  const mins = Math.floor(Math.abs(ms) / 60000);
  if (mins < 1) return 'hace un momento';
  if (mins < 60) return `hace ${mins} min`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `hace ${hrs} h`;
  const d = Math.floor(hrs / 24);
  return `hace ${d} d`;
};

export const fmtDate = (s) => (s ? new Date(s).toLocaleString() : '‚Äî');

export const money = (n) =>
  typeof n === 'number'
    ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(n)
    : 'Presupuesto por definir';

const num = (v) => (v === null || v === undefined ? null : Number(v));
export const getLat = (x) => num(x?.latitude ?? x?.lat ?? x?.coords?.lat ?? x?.location?.lat);
export const getLng = (x) => num(x?.longitude ?? x?.lng ?? x?.coords?.lng ?? x?.location?.lng);

export const chipFor = (status) => {
  const s = (status || '').toLowerCase();
  if (['pending','creada','nuevo','created'].includes(s)) return { text:'Pendiente', cls:'chip chip--warn' };
  if (['in_process','en_proceso','assigned','aceptada'].includes(s)) return { text:'En proceso', cls:'chip chip--info' };
  if (['finished','finalizada','done','completado'].includes(s)) return { text:'Finalizada', cls:'chip chip--ok' };
  if (['cancelled','canceled','rechazada'].includes(s)) return { text:'Cancelada', cls:'chip chip--bad' };
  return { text: status || '‚Äî', cls:'chip' };
};

export const I = {
  pin: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5Z"/></svg>`,
  clock:`<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1.75A10.25 10.25 0 1 0 22.25 12 10.26 10.26 0 0 0 12 1.75Zm.75 5.5h-1.5v5l4.25 2.55.75-1.23-3.5-2.07Z"/></svg>`,
  money:`<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M21 6H3a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2Zm-3 8a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3 1 1 0 1 1 2 0 1 1 0 0 0 1 1h6a1 1 0 0 0 1-1 3 3 0 0 0-3-3h-2a5 5 0 0 1-5-5h2a3 3 0 0 0 3 3h2a5 5 0 0 1 5 5Z"/></svg>`,
  service:`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="m21 16-3.59-3.59L22 7.83 20.59 6.41l-4.59 4.59L12.41 7 11 8.41l3.59 3.59L6 20h15zM3 21h4l-4-4z"/></svg>`
};
// src/stores/session.js
import { writable, derived, get } from 'svelte/store';
import { me, clearAuth } from '../api/auth.js';

export const session = writable({ user: null, loading: true });
export const isLoggedIn = derived(session, (s) => !!s?.user);

export async function checkAuth() {
  try {
    const { response, data } = await me();
    if (response?.ok) session.set({ user: data, loading: false });
    else session.set({ user: null, loading: false });
  } catch {
    session.set({ user: null, loading: false });
  }
}

export function loginSet(user) {
  session.set({ user, loading: false });
}

export function logoutAndClear() {
  try { clearAuth?.(); } catch {}
  session.set({ user: null, loading: false });
}

/** Guards para svelte-spa-router/wrap */
export function requireAuth(detail) {
  if (get(isLoggedIn)) return true;
  const next = encodeURIComponent(detail?.location || '/dashboard');
  return `/login?next=${next}`;
}

export function onlyGuests(detail) {
  if (!get(isLoggedIn)) return true;
  const qs = detail?.querystring ?? '';
  const params = new URLSearchParams(qs);
  const dest = params.get('next') || '/dashboard';
  return dest;
}
import { writable, derived, get } from 'svelte/store';
import { me, clearAuth } from '../api/auth.js';

export const session = writable({ user: null, loading: true });
export const isLoggedIn = derived(session, (s) => !!s?.user);

export async function checkAuth() {
  try {
    const { response, data } = await me();
    if (response?.ok) session.set({ user: data, loading: false });
    else session.set({ user: null, loading: false });
  } catch {
    session.set({ user: null, loading: false });
  }
}

export function loginSet(user) {
  session.set({ user, loading: false });
}

export function logoutAndClear() {
  try { clearAuth?.(); } catch {}
  session.set({ user: null, loading: false });
}

/** Conditions para svelte-spa-router/wrap */
export function requireAuth(detail) {
  if (get(isLoggedIn)) return true;
  const next = encodeURIComponent(detail?.location || '/dashboard');
  return `/login?next=${next}`;           // üëà redirecci√≥n
}

export function onlyGuests(detail) {
  if (!get(isLoggedIn)) return true;
  const qs = detail?.querystring ?? '';
  const params = new URLSearchParams(qs);
  const dest = params.get('next') || '/dashboard';
  return dest;                            // üëà redirecci√≥n
}
<script>
  import { SERVICES, REASONS, ICONS } from './services.data.js';

  // Props opcionales
  export let heading    = 'Servicios que ofrecemos';
  export let subheading = 'Encuentra el profesional adecuado para cada necesidad en tu hogar.';
  export let reasonsTitle = '¬øPor qu√© usar nuestra app?';
  export let reasonsSub  = 'Hacemos que las reparaciones y mantenimiento sean m√°s f√°ciles y seguras.';

  // Util para renderizar un path como SVG
  const Icon = ({ name, className = 'h-7 w-7' }) =>
    `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="currentColor" class="${className}" aria-hidden="true">
       <path d="${ICONS[name] ?? ''}"/>
     </svg>`;
</script>

<section class="relative overflow-hidden bg-gradient-to-b from-sky-50 to-white dark:from-slate-900 dark:to-slate-950">
  <!-- decor -->
  <div aria-hidden="true"
       class="pointer-events-none absolute inset-x-0 -top-24 h-48 bg-gradient-to-b from-blue-200/40 to-transparent blur-2xl dark:from-blue-900/30"></div>

  <div class="mx-auto max-w-[1200px] px-4 py-12 sm:py-14 md:py-16">
    <!-- header -->
    <header class="mx-auto max-w-3xl text-center">
      <h2 class="text-3xl font-extrabold tracking-tight text-blue-700 dark:text-blue-300 sm:text-4xl">
        {heading}
      </h2>
      <p class="mt-2 text-slate-600 dark:text-slate-300">
        {subheading}
      </p>
    </header>

    <!-- grid servicios -->
    <div class="mt-8 grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
      {#each SERVICES as s, i}
        <article
          class="group relative overflow-hidden rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm backdrop-blur
                 transition hover:-translate-y-0.5 hover:shadow-lg focus-within:shadow-lg dark:border-slate-700 dark:bg-slate-900/70"
          tabindex="0" aria-label={s.name}>
          <div class="flex items-start gap-3">
            <span class="grid h-11 w-11 place-items-center rounded-xl bg-blue-50 text-blue-700 ring-1 ring-blue-200
                         group-hover:scale-105 transition dark:bg-blue-900/40 dark:text-blue-200 dark:ring-blue-800"
                  aria-hidden="true">
              {@html Icon({ name: s.icon, className: 'h-6 w-6' })}
            </span>
            <div>
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white">{s.name}</h3>
              <p class="mt-1 text-sm leading-relaxed text-slate-600 dark:text-slate-300">
                {s.description}
              </p>
            </div>
          </div>

          <!-- borde animado decorativo -->
          <div class="pointer-events-none absolute inset-x-0 bottom-0 h-0.5 bg-gradient-to-r from-transparent via-blue-400/30 to-transparent
                      opacity-0 transition-opacity group-hover:opacity-100"></div>
        </article>
      {/each}
    </div>

    <!-- beneficios -->
    <div class="mt-12">
      <header class="mx-auto max-w-2xl text-center">
        <h3 class="text-2xl font-bold text-blue-700 dark:text-blue-300">{reasonsTitle}</h3>
        <p class="mt-2 text-slate-600 dark:text-slate-300">{reasonsSub}</p>
      </header>

      <div class="mt-6 grid gap-5 sm:grid-cols-2 lg:grid-cols-4">
        {#each REASONS as r}
          <div
            class="rounded-2xl border border-slate-200 bg-white/80 p-5 text-center shadow-sm backdrop-blur
                   transition hover:-translate-y-0.5 hover:shadow-lg dark:border-slate-700 dark:bg-slate-900/70">
            <div class="mx-auto mb-2 grid h-11 w-11 place-items-center rounded-xl bg-sky-50 text-sky-700 ring-1 ring-sky-200
                        dark:bg-sky-900/40 dark:text-sky-200 dark:ring-sky-800">
              {@html Icon({ name: r.icon, className: 'h-6 w-6' })}
            </div>
            <h4 class="font-semibold text-slate-900 dark:text-white">{r.title}</h4>
            <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">{r.description}</p>
          </div>
        {/each}
      </div>
    </div>
  </div>
</section>
// Fuente √∫nica de verdad para Servicios y Beneficios.
// Puedes consumir estos datos desde otros componentes/p√°ginas.

export const SERVICES = [
  {
    name: "Electricidad",
    description: "Instalaciones, reparaciones y mantenimiento el√©ctrico.",
    icon: "bolt"       // clave para el icono (ver ICONS)
  },
  {
    name: "Plomer√≠a",
    description: "Reparaciones de tuber√≠as, grifos, fugas y m√°s.",
    icon: "pipe"
  },
  {
    name: "Carpinter√≠a",
    description: "Muebles a medida, reparaciones y restauraciones.",
    icon: "hammer"
  },
  {
    name: "Limpieza",
    description: "Limpieza profunda para hogares, oficinas y exteriores.",
    icon: "broom"
  },
  {
    name: "Cerrajer√≠a",
    description: "Apertura de puertas, cambio de cerraduras y llaves.",
    icon: "lock"
  },
  {
    name: "Mantenimiento General",
    description: "Peque√±as reparaciones y mantenimiento en el hogar.",
    icon: "toolbox"
  }
];

export const REASONS = [
  {
    title: "T√©cnicos Certificados",
    description:
      "Todos los profesionales han pasado verificaci√≥n y cuentan con experiencia comprobada.",
    icon: "shield"
  },
  {
    title: "R√°pido y F√°cil",
    description:
      "Solicita un servicio en minutos, sin llamadas innecesarias ni largas esperas.",
    icon: "flash"
  },
  {
    title: "Precios Transparentes",
    description:
      "Cotizaciones claras y justas antes de contratar un servicio.",
    icon: "ticket"
  },
  {
    title: "Garant√≠a de Satisfacci√≥n",
    description:
      "Supervisi√≥n del trabajo y garant√≠a real sobre la intervenci√≥n.",
    icon: "badge"
  }
];

// Conjunto de iconos inline (Heroicons-like SVGs). 0 dependencias.
export const ICONS = {
  bolt:   'M13 2 3 14h6l-2 8 10-12h-6l2-8Z',
  pipe:   'M3 10h6v4H3v6H1V4h2v6Zm20 4h-6v-4h6V4h2v16h-2v-6Z',
  hammer: 'M2 21h8v-2H6l7.5-7.5 3 3L13 22h9v-2h-7l3-7-5-5L4 17v-4H2v8Z',
  broom:  'M4 14 2 22h2l1-4 4 4h2l-6-8Zm8-10 8 8-2 2-8-8 2-2Zm1-2 6 6 1-1a2 2 0 0 0 0-3l-3-3a2 2 0 0 0-3 0l-1 1Z',
  lock:   'M6 10V7a6 6 0 1 1 12 0v3h2v12H4V10h2Zm2 0h8V7a4 4 0 1 0-8 0v3Z',
  toolbox:'M3 8h4V6h10v2h4a2 2 0 0 1 2 2v10H1V10a2 2 0 0 1 2-2Zm6-2v2h6V6H9Zm2 8h2v4h-2v-4Z',
  shield: 'M12 2 3 6v6c0 5.55 3.84 8.74 9 10 5.16-1.26 9-4.45 9-10V6l-9-4Z',
  flash:  'M7 2h10l-5 7h5l-9 13 2-9H6l1-11Z',
  ticket: 'M3 8h4a2 2 0 1 0 0-4h10a2 2 0 1 0 0 4h4v8h-4a2 2 0 1 0 0 4H7a2 2 0 1 0 0-4H3V8Z',
  badge:  'M12 2 9 8l-7 1 5 5-1 7 6-3 6 3-1-7 5-5-7-1-3-6Z'
};
<section class="mx-auto max-w-[1100px] px-4 py-12">
  <h1 class="text-3xl font-extrabold text-blue-700">Soporte</h1>
  <p class="mt-2 text-slate-600">Contenido pr√≥ximamente.</p>
</section>
<!-- src/lib/pages/SolicitudDetalle.svelte -->
<script>
  import { onMount } from 'svelte';
  import MapLeaflet from './MapLeaflet.svelte';
  import { getRequestById, cancelRequest } from '../api/requests.js';
  import { createAssignment } from '../api/assignments.js';

  // svelte-spa-router entrega params como prop
  export let params = {};
  let id = Number(params?.id);

  // Estado base
  let loading = true;
  let error = '';
  let r = null;                // solicitud
  let chip = { text: '‚Äî', cls: 'chip' };

  // Mapa
  let latNum = 4.6486, lngNum = -74.0875; // Bogot√° fallback
  let mapRef;

  // UI local
  let acting = false;          // spinner de acciones
  let toast = null;            // { kind:'ok'|'warn'|'bad'|'info', text:string }

  // Utils ---------------------------------------------------------
  const fmtDate = (s) => (s ? new Date(s).toLocaleString() : '‚Äî');
  const money = (n) =>
    (typeof n === 'number')
      ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(n)
      : '‚Äî';

  const chipFor = (status) => {
    const s = (status || '').toLowerCase();
    if (['pending','creada','nuevo'].includes(s))   return { text:'Pendiente',  cls:'chip chip--warn' };
    if (['assigned','in_process','en_proceso'].includes(s)) return { text:'En proceso',  cls:'chip chip--info' };
    if (['finished','finalizada','done','completado'].includes(s)) return { text:'Finalizada', cls:'chip chip--ok' };
    if (['cancelled','canceled','rechazada'].includes(s))  return { text:'Cancelada',  cls:'chip chip--bad' };
    return { text: status || '‚Äî', cls: 'chip' };
  };

  const age = (s) => {
    if (!s) return '‚Äî';
    const ms = Date.now() - new Date(s).getTime();
    const m = Math.floor(ms/60000); if (m<60) return `${m} min`;
    const h = Math.floor(m/60);     if (h<24) return `${h} h`;
    return `${Math.floor(h/24)} d`;
  };

  function show(kind, text, ttl = 3000) {
    toast = { kind, text };
    setTimeout(() => (toast = null), ttl);
  }

  // Carga ---------------------------------------------------------
  async function load() {
    loading = true; error = ''; r = null;
    if (!Number.isFinite(id) || id <= 0) {
      error = 'ID de solicitud inv√°lido.'; loading = false; return;
    }
    const { response, data } = await getRequestById(id);
    if (!response?.ok) {
      error = data?.detail ?? data?.message ?? `HTTP ${response?.status}`; loading = false; return;
    }
    r = data?.item ?? data?.data ?? data ?? null;
    const lat = Number(r?.latitude ?? r?.lat), lng = Number(r?.longitude ?? r?.lng);
    if (Number.isFinite(lat) && Number.isFinite(lng)) { latNum = lat; lngNum = lng; }
    chip = chipFor(r?.status);
    loading = false;
  }

  onMount(load);

  // Acciones ------------------------------------------------------
  async function asignarTecnico() {
    if (!r?.id) return;
    acting = true;
    const { response, data } = await createAssignment(r.id);
    acting = false;
    if (!response?.ok) {
      show('bad', data?.detail ?? 'No fue posible solicitar t√©cnico.');
      return;
    }
    show('ok', 'T√©cnico solicitado correctamente.');
    await load();
  }

  async function anularSolicitud() {
    if (!r?.id) return;
    if (!confirm('¬øSeguro que deseas cancelar esta solicitud?')) return;
    acting = true;
    const { response, data } = await cancelRequest(r.id);
    acting = false;
    if (!response?.ok) {
      show('bad', data?.detail ?? 'No se pudo cancelar la solicitud.');
      return;
    }
    show('ok', 'Solicitud cancelada.');
    await load();
  }

  function openRutas() {
    const url = `https://www.google.com/maps/dir/?api=1&destination=${latNum},${lngNum}`;
    window.open(url, '_blank', 'noopener,noreferrer');
  }

  function copyDireccion() {
    const text = `${r?.address ?? ''} ${r?.city ? '¬∑ ' + r.city : ''}`.trim();
    if (!text) return;
    navigator.clipboard?.writeText(text).then(() => show('info', 'Direcci√≥n copiada'));
  }

  function goBack() {
    history.length > 1 ? history.back() : (window.location.hash = '/mis-trabajos');
  }

  // √çconos inline (sin libs) -------------------------------------
  const I = {
    back:   '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2Z"/></svg>',
    pin:    '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5.5Z"/></svg>',
    phone:  '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24 11.36 11.36 0 0 0 3.57.57 1 1 0 0 1 1 1v3.5a1 1 0 0 1-1 1A17.5 17.5 0 0 1 2.5 6a1 1 0 0 1 1-1H7a1 1 0 0 1 1 1c0 1.21.2 2.42.57 3.57a1 1 0 0 1-.25 1.02Z"/></svg>',
    mail:   '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22 6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v.4l10 5.55L22 6.4V6Zm0 2.24-9.55 5.3a1 1 0 0 1-.9 0L2 8.24V18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8.24Z"/></svg>',
    calendar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2h3V2Zm15 8v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8h20Z"/></svg>',
    peso:   '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 3h7a6 6 0 0 1 0 12H8v6H6V3Zm2 2v8h5a4 4 0 0 0 0-8H8Z"/></svg>',
    route:  '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>'
  };
</script>

<style>
  :root{
    --bg:#0B1220; --card:#0f172a; --muted:#9aa3b2; --line:#1f2937; --accent:#2563eb;
    --ok:#166534; --ok-bg:#dcfce7; --ok-br:#bbf7d0;
    --warn:#8A4B00; --warn-bg:#fff7e6; --warn-br:#ffd699;
    --info:#075985; --info-bg:#e0f2fe; --info-br:#bae6fd;
    --bad:#991b1b; --bad-bg:#fee2e2; --bad-br:#fecaca;
  }
  .page{max-width:1200px;margin:0 auto;padding:20px;color:#e5e7eb}
  .topbar{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .back{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#0b1220;color:#dbe3f2;padding:.5rem .8rem;border-radius:10px;cursor:pointer}
  .title{font:800 1.15rem/1 ui-sans-serif,system-ui;margin:0}
  .chip{padding:.28rem .65rem;border-radius:999px;font:700 12px/1 ui-sans-serif;border:1px solid #1f2937;background:#101826;color:#e5e7eb}
  .chip--ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok)}
  .chip--warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn)}
  .chip--info{background:var(--info-bg);border-color:var(--info-br);color:var(--info)}
  .chip--bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad)}

  .grid{display:grid;gap:16px}
  @media(min-width:980px){.grid{grid-template-columns:1.35fr .65fr}}

  .card{
    border:1px solid var(--line);
    background:linear-gradient(180deg,rgba(16,24,40,.9),rgba(15,23,42,.97));
    border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(2,6,23,.4)
  }
  .sectionHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:7px;font-size:14px}
  .muted{color:#b6c1d4}
  .soft{color:#9fb2d4}

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .kpi{border:1px solid var(--line);border-radius:14px;padding:10px;background:#0c1426}
  .kpi .label{font-size:12px;color:#a8b6cc}
  .kpi .val{font-weight:800;font-size:18px}

  .tagline{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.45rem .7rem;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#d2d9e6;font-size:12.5px}

  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:.65rem 1rem;border-radius:12px;border:1px solid transparent;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn.secondary{background:#0b1220;border-color:var(--line);color:#e7ecf7}
  .btn.danger{background:#7f1d1d}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .mapBox{border:1px solid var(--line);border-radius:16px;background:#0b1220;padding:10px}
  .mini{display:flex;gap:6px;align-items:center}

  .timeline{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .step{display:flex;align-items:center;gap:6px;color:#a7b1c6}
  .dot{width:9px;height:9px;border-radius:999px;background:#334155}
  .step.active .dot{background:#60a5fa;box-shadow:0 0 0 5px rgba(96,165,250,.12)}
  .step.active{color:#dbeafe}

  .divider{height:1px;background:var(--line);opacity:.5;margin:10px 0}

  .toast{position:fixed;right:16px;bottom:16px;z-index:50;border-radius:12px;padding:.7rem 1rem;border:1px solid}
  .toast.ok{border-color:var(--ok-br);background:var(--ok-bg);color:var(--ok)}
  .toast.warn{border-color:var(--warn-br);background:var(--warn-bg);color:var(--warn)}
  .toast.bad{border-color:var(--bad-br);background:var(--bad-bg);color:var(--bad)}
  .toast.info{border-color:var(--info-br);background:var(--info-bg);color:var(--info)}

  .skeleton{height:220px;border-radius:18px;border:1px solid var(--line);
    background:linear-gradient(90deg,#101827,#0f172a,#101827);background-size:200% 100%;animation:shimmer 1.1s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>

<div class="page">
  <div class="topbar">
    <button class="back" on:click={goBack} aria-label="Volver">{@html I.back}<span>Volver</span></button>
    <h1 class="title">Solicitud #{id}</h1>
    <span class={chip.cls} style="margin-left:auto">{chip.text}</span>
  </div>

  {#if loading}
    <div class="skeleton"></div>
  {:else if error}
    <div class="card" style="border-color:var(--bad-br);background:var(--bad-bg);color:var(--bad)">{error}</div>
  {:else if !r}
    <div class="card">No se encontr√≥ la solicitud.</div>
  {:else}
    <div class="grid">
      <!-- IZQUIERDA -->
      <div class="card">
        <div class="sectionHead">
          <div>
            <div style="font-weight:800;font-size:18px">
              {r.title ?? r.service?.name ?? r.service_name ?? 'Servicio'}
            </div>
            <div class="soft" style="margin-top:2px">{r.description || 'Sin descripci√≥n proporcionada.'}</div>
          </div>
          <div class="actions">
            <button class="btn" on:click={asignarTecnico} disabled={acting || ['cancelled','finished','done','finalizada'].includes((r.status||'').toLowerCase())}>
              {acting ? 'Procesando‚Ä¶' : 'Solicitar t√©cnico'}
            </button>
            <button class="btn secondary" on:click={copyDireccion}>Copiar direcci√≥n</button>
            <button class="btn danger" on:click={anularSolicitud} disabled={acting || (r.status||'').toLowerCase()==='cancelled'}>Cancelar</button>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Antig√ºedad</div>
            <div class="val">{age(r.created_at ?? r.createdAt)}</div>
          </div>
          <div class="kpi">
            <div class="label">Presupuesto</div>
            <div class="val">{r.budget ? money(r.budget) : '‚Äî'}</div>
          </div>
          <div class="kpi">
            <div class="label">Agendado</div>
            <div class="val">{r.scheduled_for ? fmtDate(r.scheduled_for) : 'Sin programar'}</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tagline">
          <span class="pill mini">{@html I.pin} {r.address ?? 'Direcci√≥n ‚Äî'}{r.city ? `, ${r.city}` : ''}</span>
          <span class="pill mini">{@html I.calendar} Creado: {fmtDate(r.created_at ?? r.createdAt)}</span>
          <span class="pill mini">{@html I.calendar} Actualizado: {fmtDate(r.updated_at ?? r.updatedAt)}</span>
        </div>

        <div class="divider"></div>

        <div style="display:grid;grid-template-columns:1fr;gap:10px">
          <div>
            <div class="muted" style="font-weight:700;margin-bottom:6px">Datos del cliente</div>
            <div class="kv">
              <div class="muted">Nombre</div><div>{r.customer?.full_name ?? '‚Äî'}</div>
              <div class="muted">Tel√©fono</div><div class="mini">{@html I.phone} {r.customer?.phone ?? r.customer?.phone_number ?? '‚Äî'}</div>
              <div class="muted">Correo</div><div class="mini">{@html I.mail} {r.customer?.email ?? '‚Äî'}</div>
            </div>
          </div>

          <div>
            <div class="muted" style="font-weight:700;margin:10px 0 6px">Ubicaci√≥n</div>
            <div class="kv">
              <div class="muted">Direcci√≥n</div><div>{r.address ?? '‚Äî'}</div>
              <div class="muted">Ciudad</div><div>{r.city ?? '‚Äî'}</div>
              <div class="muted">Coordenadas</div>
              <div>{Number.isFinite(latNum) && Number.isFinite(lngNum) ? `${latNum}, ${lngNum}` : '‚Äî'}</div>
            </div>

            <div class="mapBox" style="margin-top:8px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div class="muted">Ubicaci√≥n exacta</div>
                <div class="actions">
                  <button class="btn secondary" on:click={() => mapRef?.locateMe?.()}>Usar mi ubicaci√≥n</button>
                  <button class="btn secondary" on:click={openRutas}>Abrir rutas</button>
                </div>
              </div>
              <MapLeaflet bind:this={mapRef} bind:lat={latNum} bind:lng={lngNum} editable={false} />
            </div>
          </div>
        </div>
      </div>

      <!-- DERECHA -->
      <div class="card">
        <div class="sectionHead">
          <div style="font-weight:800">Resumen</div>
          <span class={chip.cls}>{chip.text}</span>
        </div>

        <div class="kv" style="margin-bottom:8px">
          <div class="muted">Estado</div><div>{r.status ?? '‚Äî'}</div>
          <div class="muted">Servicio</div><div>{r.service?.name ?? r.service_name ?? '‚Äî'}</div>
          <div class="muted">Presupuesto</div><div>{r.budget ? money(r.budget) : 'Por definir'}</div>
          <div class="muted">Agendado</div><div>{r.scheduled_for ? fmtDate(r.scheduled_for) : 'Sin programar'}</div>
        </div>

        <div class="muted" style="font-weight:700;margin-top:8px">Estado del proceso</div>
        <div class="timeline">
          <div class="step {['pending','creada','nuevo'].includes((r.status||'').toLowerCase()) ? 'active' : ''}">
            <span class="dot"></span><span>Creada</span>
          </div>
          <div class="step {['assigned','in_process','en_proceso'].includes((r.status||'').toLowerCase()) ? 'active' : ''}">
            <span class="dot"></span><span>Asignada</span>
          </div>
          <div class="step {['in_process','en_proceso'].includes((r.status||'').toLowerCase()) ? 'active' : ''}">
            <span class="dot"></span><span>En proceso</span>
          </div>
          <div class="step {['finished','finalizada','done','completado'].includes((r.status||'').toLowerCase()) ? 'active' : ''}">
            <span class="dot"></span><span>Finalizada</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted" style="font-weight:700;margin:6px 0">Acciones r√°pidas</div>
        <div class="actions">
          <button class="btn" on:click={asignarTecnico} disabled={acting || ['cancelled','finished','done','finalizada'].includes((r.status||'').toLowerCase())}>
            {acting ? 'Procesando‚Ä¶' : 'Solicitar t√©cnico'}
          </button>
          <button class="btn secondary" on:click={copyDireccion}>Copiar direcci√≥n</button>
          <button class="btn danger" on:click={anularSolicitud} disabled={acting || (r.status||'').toLowerCase()==='cancelled'}>Cancelar</button>
        </div>
      </div>
    </div>
  {/if}

  {#if toast}
    <div class="toast {toast.kind==='ok'?'ok':toast.kind==='warn'?'warn':toast.kind==='bad'?'bad':'info'}">{toast.text}</div>
  {/if}
</div>
<script>
  import { onMount } from 'svelte';
  import { push } from 'svelte-spa-router';
  import { createRequest, listServices, nearbyTechnicians } from '../api/requests.js';
  import MapLeaflet from '../pages/MapLeaflet.svelte';

  // ---------- Fallback local (frontend) ----------
  const FALLBACK_SERVICES = [
    { slug: 'electricidad',       name: 'Electricidad (cableado, tomas, cortos)' },
    { slug: 'plomeria',           name: 'Plomer√≠a (fugas, grifer√≠a, destapes)' },
    { slug: 'electrodomesticos',  name: 'Electrodom√©sticos (lavadora, nevera, microondas)' },
  ];
  let usingFallback = false;

  // ---------- estado ----------
  let loading = true, saving = false;
  let services = [], message = '', kind = 'info';

  let service_id = ''; // puede ser id (string num√©rica) o slug (string)
  let description = '', address = '', city = '', budget = '';
  let scheduled_for = ''; // input datetime-local

  // Coordenadas. Centro por defecto: Bogot√°
  let latNum = 4.6486, lngNum = -74.0875;

  // Referencia al mapa para llamar locateMe()
  let mapRef;

  let suggestions = [];
  const canSubmit = () => service_id && address && !saving;

  // Utils
  const slugify = (s) =>
    (s || '')
      .toString()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');

  onMount(async () => {
    // Carga desde API con tolerancia a forma {items} o array plano
    try {
      const res = await listServices({ page: 1, size: 100 });
      const ok = res?.response?.ok;
      const apiItems =
        res?.items ??
        (Array.isArray(res?.data) ? res.data : res?.data?.items) ??
        [];

      if (ok && apiItems.length) {
        services = apiItems;              // objetos con {id, name}
        usingFallback = false;
      } else {
        services = FALLBACK_SERVICES;     // objetos con {slug, name}
        usingFallback = true;
      }
    } catch {
      services = FALLBACK_SERVICES;
      usingFallback = true;
    } finally {
      loading = false;
    }

    // Prefijar geolocalizaci√≥n (opcional)
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        ({ coords }) => {
          latNum = Number(coords.latitude.toFixed(6));
          lngNum = Number(coords.longitude.toFixed(6));
          loadNearby();
        },
        () => {}
      );
    }
  });

  async function loadNearby() {
    suggestions = [];
    const { response, data } = await nearbyTechnicians({
      latitude: Number(latNum), longitude: Number(lngNum),
    });
    if (response?.ok) suggestions = data ?? [];
  }

  // Intenta obtener el ID real del servicio si el valor es un slug (fallback)
  async function resolveServiceId(value) {
    // si ya es id num√©rico v√°lido
    const asNum = Number(value);
    if (Number.isFinite(asNum) && asNum > 0) return asNum;

    // si es slug, reintenta contra API por nombre parecido
    const res = await listServices({ page: 1, size: 200 });
    const apiItems =
      res?.items ??
      (Array.isArray(res?.data) ? res.data : res?.data?.items) ??
      [];

    const picked = services.find(s => (s.id ?? s.slug) == value);
    const targetSlug = slugify(picked?.name ?? value);

    const match = apiItems.find(it => slugify(it.name) === targetSlug);
    return match?.id ? Number(match.id) : null;
  }

  async function submit(e) {
    e.preventDefault();
    if (!canSubmit()) return;

    saving = true; message = ''; kind = 'info';

    // Resuelve id real (si estamos usando fallback)
    let resolvedId = await resolveServiceId(service_id);
    if (!resolvedId) {
      message = 'Ese servicio todav√≠a no est√° creado en el servidor. ' +
                'Crea los servicios en el backend o habilita el seed.';
      kind = 'error'; saving = false; return;
    }

    const payload = {
      service_id: resolvedId,
      description: description || null,
      address,
      city: city || null,
      budget: budget ? Number(budget) : null,
      latitude: Number.isFinite(latNum) ? Number(latNum) : null,
      longitude: Number.isFinite(lngNum) ? Number(lngNum) : null,
      scheduled_for: scheduled_for ? new Date(scheduled_for).toISOString() : null,
    };

    const { response, data } = await createRequest(payload);
    if (!response.ok) {
      message = data?.detail ?? 'No se pudo crear la solicitud';
      kind = 'error'; saving = false; return;
    }

    message = '¬°Solicitud enviada! Te avisaremos cuando sea asignada.';
    kind = 'success';
    setTimeout(() => push('/dashboard'), 700);
  }

  // üìç Bot√≥n "Usar mi ubicaci√≥n"
  function usarMiUbicacion() {
    mapRef?.locateMe(); // actualiza lat/lng y centra el mapa
  }
</script>

<div class="min-h-screen bg-slate-950 text-white/90">
  <div class="mx-auto max-w-3xl px-6 py-8">
    <h1 class="mb-2 text-2xl font-bold">Nueva solicitud</h1>
    {#if usingFallback}
      <p class="mb-4 text-xs text-amber-300">
        Usando cat√°logo de servicios temporal del frontend. Crea los servicios en el backend para que el env√≠o funcione.
      </p>
    {/if}

    {#if loading}
      <div class="h-40 animate-pulse rounded-2xl bg-white/10" />
    {:else}
      <form on:submit={submit}
            class="space-y-5 rounded-2xl border border-white/10 bg-white/10 p-6">

        <div>
          <label class="mb-1 block text-sm text-white/80">Servicio</label>
          <select class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                  bind:value={service_id} required>
            <option value="" disabled>Selecciona un servicio‚Ä¶</option>
            {#each services as s}
              <!-- value puede ser s.id (API) o s.slug (fallback) -->
              <option value={(s.id ?? s.slug) + ''}>{s.name}</option>
            {/each}
          </select>
        </div>

        <div>
          <label class="mb-1 block text-sm text-white/80">Descripci√≥n</label>
          <textarea class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                    rows="3" bind:value={description}
                    placeholder="Describe el problema‚Ä¶"/>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="mb-1 block text-sm text-white/80">Direcci√≥n</label>
            <input class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                   bind:value={address} placeholder="Calle 123 #45-67" required />
          </div>
          <div>
            <label class="mb-1 block text-sm text-white/80">Ciudad</label>
            <input class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                   bind:value={city} placeholder="Bogot√°" />
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-3">
          <div>
            <label class="mb-1 block text-sm text-white/80">Presupuesto (opcional)</label>
            <input type="number" min="0" step="1"
                   class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                   bind:value={budget} placeholder="80000" />
          </div>
          <div>
            <label class="mb-1 block text-sm text-white/80">Fecha y hora (opcional)</label>
            <input type="datetime-local"
                   class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                   bind:value={scheduled_for} />
          </div>
        </div>

        <!-- Coordenadas + Mapa -->
        <div class="space-y-3">
          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label class="mb-1 block text-sm text-white/80">Latitud</label>
              <input type="number" step="0.000001"
                     class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                     bind:value={latNum} placeholder="4.656100" />
            </div>
            <div>
              <label class="mb-1 block text-sm text-white/80">Longitud</label>
              <input type="number" step="0.000001"
                     class="w-full rounded-xl border border-white/20 bg-white/80 px-3 py-2 text-slate-900"
                     bind:value={lngNum} placeholder="-74.059000" />
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button type="button"
                    class="rounded-xl bg-white/20 px-3 py-2 text-sm hover:bg-white/30"
                    on:click={usarMiUbicacion}>
              üìç Usar mi ubicaci√≥n
            </button>
            <button type="button"
                    class="rounded-xl bg-white/20 px-3 py-2 text-sm hover:bg-white/30"
                    on:click={loadNearby}>
              Buscar t√©cnicos cercanos
            </button>
            {#if suggestions.length}
              <span class="text-xs text-white/70">{suggestions.length} t√©cnicos cerca</span>
            {/if}
          </div>

          <!-- Mapa Leaflet -->
          <div class="rounded-2xl border border-white/10 bg-white/10 p-3">
            <h3 class="mb-2 text-sm text-white/70">Selecciona la ubicaci√≥n en el mapa</h3>
            <MapLeaflet bind:this={mapRef}
                        bind:lat={latNum}
                        bind:lng={lngNum}
                        editable={true}
                        on:moved={loadNearby} />
          </div>
        </div>

        {#if message}
          <div class={`rounded-xl border px-3 py-2 text-sm flex items-center gap-2
            ${kind === 'error' ? 'border-rose-400/50 bg-rose-500/10 text-rose-100'
              : kind === 'success' ? 'border-emerald-400/50 bg-emerald-500/10 text-emerald-100'
              : 'border-white/30 bg-white/10 text-white/90'}`}>
            {#if kind === 'success'}
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                   fill="currentColor" class="h-5 w-5 shrink-0">
                <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-7.364 7.364a1 1 0 01-1.414 0L3.293 9.536a1 1 0 111.414-1.414l3.022 3.022 6.657-6.657a1 1 0 011.414 0z"
                      clip-rule="evenodd" />
              </svg>
            {/if}
            <span>{message}</span>
          </div>
        {/if}

        <button class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 text-white
                       hover:brightness-110 disabled:opacity-60"
                disabled={!canSubmit() || saving}>
          {#if saving}
            Creando‚Ä¶
          {:else}
            Enviar solicitud
          {/if}
        </button>
      </form>
    {/if}
  </div>
</div>
<script>
  let termino = "";
  let fechaDesde = "";
  let fechaHasta = "";
  let rol = "";
  function buscar(e) { e.preventDefault(); /* no funcional por requisito */ }
</script>

<section class="container">
  <h1>Reporte (Demo no funcional)</h1>
  <form on:submit|preventDefault={buscar} class="f">
    <label>
      T√©rmino:
      <input bind:value={termino} placeholder="usuario, servicio, solicitud..." />
    </label>
    <label>
      Desde:
      <input type="date" bind:value={fechaDesde} />
    </label>
    <label>
      Hasta:
      <input type="date" bind:value={fechaHasta} />
    </label>
    <label>
      Rol:
      <select bind:value={rol}>
        <option value="">Todos</option>
        <option>Admin</option>
        <option>T√©cnico</option>
        <option>Cliente</option>
      </select>
    </label>
    <button type="submit">Buscar</button>
  </form>

  <h2>Resultados</h2>
  <table class="tbl">
    <thead>
      <tr><th>ID</th><th>Entidad</th><th>Detalle</th><th>Fecha</th><th>Estado</th></tr>
    </thead>
    <tbody>
      <tr><td colSpan="5">Demostraci√≥n: sin conexi√≥n a√∫n (requisito del parcial).</td></tr>
    </tbody>
  </table>
</section>

<style>
  .container { max-width: 1100px; margin: 2rem auto; padding: 1rem; }
  .f { display: grid; grid-template-columns: repeat(5, 1fr); gap: .75rem; align-items: end; }
  .f label { display:flex; flex-direction:column; font-size:.9rem; }
  .tbl { width:100%; border-collapse: collapse; margin-top:1rem; }
  .tbl th, .tbl td { border:1px solid #ddd; padding:.5rem; text-align:left; }
</style>
<script>
  import { link, push } from 'svelte-spa-router';
  import { register } from '../api/auth.js';
  import { fade, fly } from 'svelte/transition';

  export let brand = 'RIB';
  export let logoSrc = '/logo.png';

  let full_name = '';
  let phone_number = '';
  let email = '';
  let password = '';
  let confirm = '';
  let remember = true;
  let acceptTerms = true;

  let showPass = false;
  let showConfirm = false;
  let loading = false;
  let message = '';
  let messageKind = 'info';

  const emailOk = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  const passScore = (v) => {
    let s = 0;
    if (v.length >= 8) s++;
    if (/[a-z]/.test(v) && /[A-Z]/.test(v)) s++;
    if (/\d/.test(v)) s++;
    if (/[^a-zA-Z0-9]/.test(v)) s++;
    if (v.length >= 12) s++;
    return Math.min(s, 5);
  };
  $: score = passScore(password);
  $: strengthPct = (score / 5) * 100;
  $: strengthLabel = ['Muy d√©bil','D√©bil','Aceptable','Fuerte','Excelente'][Math.max(0, score-1)] || 'Muy d√©bil';
  $: strengthClass = score <= 2 ? 'bg-rose-500' : score === 3 ? 'bg-amber-500' : 'bg-emerald-500';
  $: canSubmit = emailOk(email) && password.length >= 6 && password === confirm && acceptTerms && !loading;

  function formatPhone(e) {
    const digits = e.target.value.replace(/\D/g, '').slice(0, 15);
    phone_number = digits.replace(/(\d{3})(?=\d)/g, '$1 ').trim();
  }

  function genStrongPassword() {
    const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()-_=+[]{}?';
    let out=''; for (let i=0;i<16;i++) out += chars[Math.floor(Math.random()*chars.length)];
    password = out; confirm = out;
  }

  async function handleRegister(e) {
    e.preventDefault();
    message = ''; messageKind = 'info';
    if (!canSubmit) { message='Revisa los campos marcados y acepta los t√©rminos.'; messageKind='error'; return; }

    loading = true;
    try {
      const { response, data } = await register({ email, password, full_name, phone_number });
      if (!response.ok) {
        const detail = data?.detail ?? 'No se pudo registrar el usuario.';
        message = typeof detail === 'string' ? detail : JSON.stringify(detail);
        messageKind = 'error';
        return;
      }
      if (typeof window !== 'undefined' && data?.access_token) {
        const storageKey='auth';
        const target = remember ? window.localStorage : window.sessionStorage;
        const other  = remember ? window.sessionStorage : window.localStorage;
        other.removeItem(storageKey);
        target.setItem(storageKey, JSON.stringify(data));
      }
      message='¬°Cuenta creada con √©xito! Redirigiendo‚Ä¶'; messageKind='success';
      setTimeout(()=>{ full_name=phone_number=email=password=confirm=''; push('/dashboard'); }, 600);
    } catch (err) {
      console.error(err); message='No se pudo conectar con el servidor.'; messageKind='error';
    } finally { loading=false; }
  }
</script>

<!-- Fondo aurora -->
<div class="relative min-h-screen overflow-hidden bg-slate-950">
  <div class="pointer-events-none absolute inset-0 opacity-60 mix-blend-screen">
    <div class="aurora aurora-1"></div>
    <div class="aurora aurora-2"></div>
    <div class="aurora aurora-3"></div>
  </div>

  <div class="relative z-10 mx-auto grid min-h-screen max-w-6xl grid-cols-1 items-center gap-8 px-6 py-10 md:grid-cols-2">
    <!-- Lado branding -->
    <div in:fly={{ x: -16, duration: 350 }} class="text-white/90">
      <div class="mb-6 flex items-center gap-3">
        <img src={logoSrc} alt={brand} class="h-12 w-12 rounded-xl ring-1 ring-white/20 object-cover" />
        <div>
          <h1 class="text-2xl font-semibold">{brand}</h1>
          <p class="text-sm text-white/60">Servicios inmediatos, sin complicaciones.</p>
        </div>
      </div>
      <h2 class="mb-4 text-4xl font-bold tracking-tight">
        Crea tu cuenta <span class="text-indigo-300">en segundos</span>
      </h2>
      <ul class="space-y-3 text-sm text-white/80">
        <li class="flex items-start gap-3">
          <!-- check -->
          <svg class="mt-0.5 h-5 w-5 text-emerald-400" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41Z"/></svg>
          Solicita y gestiona reparaciones en tiempo real
        </li>
        <li class="flex items-start gap-3">
          <svg class="mt-0.5 h-5 w-5 text-emerald-400" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41Z"/></svg>
          Geolocalizaci√≥n de t√©cnicos y seguimiento del servicio
        </li>
        <li class="flex items-start gap-3">
          <svg class="mt-0.5 h-5 w-5 text-emerald-400" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41Z"/></svg>
          Historial, calificaciones y soporte dedicado
        </li>
      </ul>
    </div>

    <!-- Form -->
    <form
      on:submit|preventDefault={handleRegister}
      class="rounded-3xl border border-white/10 bg-white/10 p-6 shadow-2xl backdrop-blur-xl md:p-8"
      in:fly={{ x: 16, duration: 350 }}
      aria-labelledby="title-reg"
    >
      <div class="mb-6 text-center">
        <h3 id="title-reg" class="text-2xl font-bold text-white">Crear cuenta</h3>
        <p class="text-sm text-white/70">Completa tus datos para comenzar</p>
      </div>

      <!-- Nombre -->
      <div class="mb-4">
        <label class="mb-1 block text-sm text-white/80">Nombre completo</label>
        <div class="relative">
          <input
            class="w-full rounded-2xl border border-white/15 bg-white/70 px-4 py-3 text-slate-900 outline-none shadow-sm placeholder:text-slate-400 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200"
            bind:value={full_name}
            placeholder="Tu nombre" aria-label="Nombre completo" />
          <!-- user icon -->
          <svg class="pointer-events-none absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.67-8 6h16c0-3.33-2.67-6-8-6Z"/></svg>
        </div>
      </div>

      <!-- Tel√©fono -->
      <div class="mb-4">
        <label class="mb-1 block text-sm text-white/80">Tel√©fono</label>
        <div class="relative">
          <input
            class="w-full rounded-2xl border border-white/15 bg-white/70 px-4 py-3 text-slate-900 outline-none shadow-sm placeholder:text-slate-400 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200"
            value={phone_number}
            on:input={formatPhone}
            placeholder="300 123 4567" aria-label="Tel√©fono (opcional)" />
          <!-- phone icon -->
          <svg class="pointer-events-none absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-500" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.1 15.1 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.05-.24 11.36 11.36 0 0 0 3.56.57 1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A16 16 0 0 1 3 8a1 1 0 0 1 1-1h2.49a1 1 0 0 1 1 1 11.36 11.36 0 0 0 .57 3.56 1 1 0 0 1-.24 1.05Z"/></svg>
        </div>
      </div>

      <!-- Email -->
      <div class="mb-4">
        <label class="mb-1 block text-sm text-white/80">Correo</label>
        <div class="relative">
          <input
            type="email"
            class="w-full rounded-2xl border border-white/15 bg-white/70 px-4 py-3 text-slate-900 outline-none shadow-sm placeholder:text-slate-400 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200"
            bind:value={email}
            placeholder="tu@correo.com"
            aria-invalid={!email ? undefined : !emailOk(email)}
            required />
          {#if email && emailOk(email)}
            <svg class="absolute right-3 top-1/2 h-5 w-5 -translate-y-1/2 text-emerald-600" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41Z"/></svg>
          {/if}
        </div>
      </div>

      <!-- Password -->
      <div class="mb-3">
        <label class="mb-1 block text-sm text-white/80">Contrase√±a</label>
        <div class="relative">
          <input
            id="password"
            type={showPass ? 'text' : 'password'}
            class="w-full rounded-2xl border border-white/15 bg-white/70 px-4 py-3 text-slate-900 outline-none shadow-sm placeholder:text-slate-400 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200"
            bind:value={password}
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            aria-describedby="pwd-hint"
            required />
          <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 rounded-xl px-2 py-1 text-slate-700 hover:bg-white/60"
            on:click={() => (showPass = !showPass)} aria-label="Mostrar u ocultar contrase√±a">
            {#if showPass}
              <!-- eye-off -->
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="m3 4.27 1.28-1.27 18 18-1.27 1.27-3.2-3.2A10.73 10.73 0 0 1 12 20c-5.05 0-9.38-3.2-11-8 1-2.95 3.12-5.35 5.77-6.67L3 4.27Zm6.82 6.82a2.22 2.22 0 0 0 3.06 3.06l-3.06-3.06ZM12 6c5.05 0 9.38 3.2 11 8-.64 1.88-1.79 3.54-3.27 4.87l-1.43-1.43A8.67 8.67 0 0 0 20.88 14c-1.46-3.67-4.93-6-8.88-6-1 0-1.96.13-2.86.38L7.85 6.1A10.72 10.72 0 0 1 12 6Z"/></svg>
            {:else}
              <!-- eye -->
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c5.05 0 9.38 3.2 11 8-1.62 4.8-5.95 8-11 8s-9.38-3.2-11-8c1.62-4.8 5.95-8 11-8Zm0 3a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 8Z"/></svg>
            {/if}
          </button>
        </div>

        <!-- Fuerza -->
        <div class="mt-2 h-2 w-full rounded-full bg-white/20">
          <div class={`h-2 rounded-full ${strengthClass}`} style={`width:${strengthPct}%; transition:width .25s`}></div>
        </div>
        <div id="pwd-hint" class="mt-1 flex items-center justify-between text-xs text-white/80">
          <span>Fuerza: <b>{strengthLabel}</b></span>
          <button type="button" class="underline hover:opacity-80" on:click={genStrongPassword}>Generar segura</button>
        </div>
      </div>

      <!-- Confirmaci√≥n -->
      <div class="mb-4">
        <label class="mb-1 block text-sm text-white/80">Confirmar contrase√±a</label>
        <div class="relative">
          <input
            type={showConfirm ? 'text' : 'password'}
            class="w-full rounded-2xl border border-white/15 bg-white/70 px-4 py-3 text-slate-900 outline-none shadow-sm placeholder:text-slate-400 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200"
            bind:value={confirm}
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 rounded-xl px-2 py-1 text-slate-700 hover:bg-white/60"
            on:click={() => (showConfirm = !showConfirm)} aria-label="Mostrar u ocultar confirmaci√≥n">
            {#if showConfirm}
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="m3 4.27 1.28-1.27 18 18-1.27 1.27-3.2-3.2A10.73 10.73 0 0 1 12 20c-5.05 0-9.38-3.2-11-8 1-2.95 3.12-5.35 5.77-6.67L3 4.27Zm6.82 6.82a2.22 2.22 0 0 0 3.06 3.06l-3.06-3.06ZM12 6c5.05 0 9.38 3.2 11 8-.64 1.88-1.79 3.54-3.27 4.87l-1.43-1.43A8.67 8.67 0 0 0 20.88 14c-1.46-3.67-4.93-6-8.88-6-1 0-1.96.13-2.86.38L7.85 6.1A10.72 10.72 0 0 1 12 6Z"/></svg>
            {:else}
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c5.05 0 9.38 3.2 11 8-1.62 4.8-5.95 8-11 8s-9.38-3.2-11-8c1.62-4.8 5.95-8 11-8Zm0 3a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 8Z"/></svg>
            {/if}
          </button>
        </div>
        {#if confirm && confirm !== password}
          <p class="mt-1 text-xs text-rose-300">Las contrase√±as no coinciden.</p>
        {/if}
      </div>

      <!-- Switches -->
      <div class="mb-4 flex flex-col gap-2 text-sm text-white/80 md:flex-row md:items-center md:justify-between">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" bind:checked={remember} class="h-4 w-4 rounded border-white/30 text-indigo-500" />
          Recu√©rdame
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" bind:checked={acceptTerms} class="h-4 w-4 rounded border-white/30 text-indigo-500" />
          Acepto los <a href="/terminos" use:link class="underline">t√©rminos</a>
        </label>
      </div>

      <!-- Mensaje -->
      {#if message}
        <div class={`mb-4 rounded-2xl border px-4 py-3 text-sm ${messageKind === 'error'
          ? 'border-rose-400/50 bg-rose-500/10 text-rose-100'
          : messageKind === 'success'
          ? 'border-emerald-400/50 bg-emerald-500/10 text-emerald-100'
          : 'border-white/30 bg-white/10 text-white/90'}`} in:fade>
          {message}
        </div>
      {/if}

      <!-- Bot√≥n -->
      <button
        class="group relative inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-indigo-600 px-4 py-3 text-white shadow-lg shadow-indigo-600/30 transition hover:brightness-110 active:scale-[.99] disabled:opacity-60"
        disabled={!canSubmit}
      >
        {#if loading}
          <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 4v2m0 12v2m8-8h-2M6 12H4m12.95 5.657-1.414-1.414M8.464 8.464 7.05 7.05m10.607 0-1.414 1.414M8.464 15.536 7.05 16.95"/>
          </svg>
          Creando cuenta‚Ä¶
        {:else}
          Crear cuenta
          <svg class="h-5 w-5 transition group-hover:translate-x-0.5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 5l7 7-7 7v-4H4v-6h9V5z"/>
          </svg>
        {/if}
      </button>

      <p class="mt-6 text-center text-sm text-white/80">
        ¬øYa tienes cuenta? <a href="/login" use:link class="font-medium underline">Inicia sesi√≥n</a>
      </p>
    </form>
  </div>
</div>

<style>
  .aurora { position:absolute; inset:-20%; filter: blur(60px); }
  .aurora-1 { background: radial-gradient(600px 300px at 10% 10%, rgba(99,102,241,.55), transparent 60%); animation: float1 16s ease-in-out infinite; }
  .aurora-2 { background: radial-gradient(500px 260px at 80% 30%, rgba(216,180,254,.5), transparent 60%); animation: float2 18s ease-in-out infinite; }
  .aurora-3 { background: radial-gradient(520px 280px at 50% 80%, rgba(16,185,129,.45), transparent 60%); animation: float3 22s ease-in-out infinite; }
  @keyframes float1 { 0%,100%{transform:translateY(0)} 50%{transform:translateY(20px)} }
  @keyframes float2 { 0%,100%{transform:translateX(0)} 50%{transform:translateX(-20px)} }
  @keyframes float3 { 0%,100%{transform:translate(0,0)} 50%{transform:translate(15px,-10px)} }
</style>
<script>
  import { onMount } from 'svelte';
  import { push } from 'svelte-spa-router';
  import { authedFetch } from '../api/auth.js';
  import { getMyTechnicianProfile } from '../api/technicians.js';
  import { createAssignment, setAssignmentStatus } from '../api/assignments.js';
  import AssignmentCard from '../components/AssignmentCard.svelte';
  import RequestCard from '../components/RequestCard.svelte';

  let tab = 'asignaciones';
  let hasTech = false;

  let assignments = [];
  let requests = [];

  let loadingA = true, loadingR = true;
  let errA = '', errR = '', techError = '';

  let creatingFor = null;
  let switchingId = null;

  function goLogin() {
    const next = encodeURIComponent('/mis-trabajos');
    window.location.hash = `/login?next=${next}`;
  }

  async function loadAssignments(page=1, size=10) {
    loadingA = true; errA = '';
    const { response, data } = await authedFetch(`/assignments/?page=${page}&size=${size}`);
    if (response.status === 401) { goLogin(); return; }
    if (!response.ok) { errA = (data?.detail && (Array.isArray(data.detail) ? data.detail.map(x=>x.msg).join(' ¬∑ ') : data.detail)) ?? `No se pudieron cargar (HTTP ${response.status})`; assignments = []; }
    else { assignments = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []); }
    loadingA = false;
  }

  async function loadRequests(page=1, size=10) {
    loadingR = true; errR = '';
    const { response, data } = await authedFetch(`/requests/?page=${page}&size=${size}`);
    if (response.status === 401) { goLogin(); return; }
    if (!response.ok) { errR = (data?.detail && (Array.isArray(data.detail) ? data.detail.map(x=>x.msg).join(' ¬∑ ') : data.detail)) ?? `No se pudieron cargar (HTTP ${response.status})`; requests = []; }
    else { requests = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []); }
    loadingR = false;
  }

  onMount(async () => {
    try { const { response } = await getMyTechnicianProfile(); hasTech = !!response?.ok; } catch { hasTech = false; }
    tab = hasTech ? 'asignaciones' : 'solicitudes';
    await Promise.all([loadAssignments(), loadRequests()]);
  });

  // acciones
  const viewRequest  = (r) => { const id = r?.id ?? r?.request_id; if (id) push(`/solicitud/${id}`); };
  const viewAssign   = (a) => { const id = a?.id ?? a?.assignment_id; if (id) push(`/asignacion/${id}`); };

  async function requestTechnician(r){
    const reqId = r?.id ?? r?.request_id; if (!reqId) return;
    creatingFor = reqId;
    const { response, data } = await createAssignment(reqId);
    if (!response?.ok) alert(data?.detail ?? 'No se pudo crear la asignaci√≥n');
    else { await Promise.all([loadAssignments(), loadRequests()]); alert('¬°T√©cnico solicitado!'); }
    creatingFor = null;
  }

  async function acceptAssignment(a){
    const id = a?.id ?? a?.assignment_id; if (!id) return;
    switchingId = id;
    const { response, data } = await setAssignmentStatus(id, 'in_process');
    if (!response?.ok) alert(data?.detail ?? 'No se pudo aceptar');
    else await loadAssignments();
    switchingId = null;
  }

  async function finishAssignment(a){
    const id = a?.id ?? a?.assignment_id; if (!id) return;
    switchingId = id;
    const { response, data } = await setAssignmentStatus(id, 'finished');
    if (!response?.ok) alert(data?.detail ?? 'No se pudo finalizar');
    else { await loadAssignments(); alert('Trabajo finalizado.'); }
    switchingId = null;
  }
</script>

<style>
  :root{
    --bg:#0B1220; --card:#0f172a; --muted:#9aa3b2; --line:#1f2937; --accent:#2563eb;
    --ok:#166534; --ok-bg:#dcfce7; --ok-br:#bbf7d0; --warn:#8A4B00; --warn-bg:#fff7e6; --warn-br:#ffd699;
    --info:#075985; --info-bg:#e0f2fe; --info-br:#bae6fd; --bad:#991b1b; --bad-bg:#fee2e2; --bad-br:#fecaca;
  }
  .page{max-width:1100px;margin:0 auto;padding:20px}
  .title{color:#fff;margin:.25rem 0 1rem;font:600 1.35rem/1.2 ui-sans-serif,system-ui}
  .tabs{display:flex;gap:.5rem;margin-bottom:14px}
  .tab{padding:.55rem .95rem;border-radius:999px;border:1px solid var(--line);background:#0f172a;color:#d1d5db;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}
  .cardInfo{border:1px dashed var(--line);border-radius:16px;padding:16px;color:#e5e7eb;background:linear-gradient(180deg,rgba(16,24,40,.85),rgba(15,23,42,.92))}
  .muted{color:#9aa3b2}
  .skeleton{height:150px;border-radius:16px;border:1px solid var(--line);background:linear-gradient(90deg,#101827,#0f172a,#101827);background-size:200% 100%;animation:shimmer 1.2s infinite}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>

<div class="page">
  <h1 class="title">Mis trabajos</h1>

  <div class="tabs">
    <button class="tab {tab==='asignaciones' ? 'active' : ''}" on:click={() => tab='asignaciones'}>Asignaciones</button>
    <button class="tab {tab==='solicitudes' ? 'active' : ''}" on:click={() => tab='solicitudes'}>Mis solicitudes</button>
  </div>

  {#if tab==='asignaciones'}
    {#if !hasTech}
      <div class="cardInfo">
        <b>Sin perfil t√©cnico</b>
        <div class="muted">Crea tu perfil desde <b>Perfil t√©cnico</b> para recibir asignaciones.</div>
      </div>
    {/if}
    {#if errA}<div class="cardInfo"><div class="muted">{errA}</div></div>{/if}

    {#if loadingA}
      <div class="grid"><div class="skeleton"></div><div class="skeleton"></div></div>
    {:else if assignments.length===0}
      <div class="muted">No hay asignaciones para mostrar.</div>
    {:else}
      <div class="grid">
        {#each assignments as a (a.id ?? a.assignment_id)}
          <AssignmentCard
            {a}
            {switchingId}
            onView={() => viewAssign(a)}
            onAccept={() => acceptAssignment(a)}
            onFinish={() => finishAssignment(a)}
          />
        {/each}
      </div>
    {/if}
  {:else}
    {#if errR}<div class="cardInfo"><div class="muted">{errR}</div></div>{/if}
    {#if loadingR}
      <div class="grid"><div class="skeleton"></div><div class="skeleton"></div></div>
    {:else if requests.length===0}
      <div class="muted">A√∫n no has creado solicitudes.</div>
    {:else}
      <div class="grid">
        {#each requests as r (r.id ?? r.request_id)}
          <RequestCard
            {r}
            {creatingFor}
            onView={() => viewRequest(r)}
            onRequestTech={() => requestTechnician(r)}
          />
        {/each}
      </div>
    {/if}
  {/if}
</div>
<script>
  import { onMount } from 'svelte';
  import { link, push } from 'svelte-spa-router';
  import { clearAuth, me } from '../api/auth.js';
  import { fetchRequests, fetchAssignments } from '../api/dashboard.js';

  let loading = true;
  let user = null;
  let kpis = { requestsTotal: 0, assignmentsTotal: 0 };
  let lastRequests = [];
  let lastAssignments = [];
  let errorMsg = '';

  function logout() {
    clearAuth();
    push('/login');
  }

  onMount(async () => {
    loading = true; errorMsg = '';
    // 1) sesi√≥n
    const { response: r1, data: d1 } = await me();
    if (r1?.status === 401) { logout(); return; }
    if (!r1?.ok) { errorMsg = 'No se pudo cargar tu sesi√≥n.'; loading = false; return; }
    user = d1;

    // 2) datos del dashboard (opcional para admin tambi√©n)
    const [reqRes, asgRes] = await Promise.all([
      fetchRequests({ size: 5 }),
      fetchAssignments({ size: 5 })
    ]);

    if (reqRes?.response?.ok) {
      kpis.requestsTotal = reqRes.total ?? 0;
      lastRequests = reqRes.items ?? [];
    }
    if (asgRes?.response?.ok) {
      kpis.assignmentsTotal = asgRes.total ?? 0;
      lastAssignments = asgRes.items ?? [];
    }

    loading = false;
  });

  const isAdmin = () => !!user?.is_superuser;

  function fmtDate(v) {
    try { return new Date(v).toLocaleString(); } catch { return v ?? '‚Äî'; }
  }
</script>

<div class="min-h-screen bg-slate-950 text-white/90">
  <main class="mx-auto max-w-7xl px-6 py-8">
    {#if loading}
      <div class="grid gap-6 md:grid-cols-3">
        {#each Array.from({ length: 6 }) as _}
          <div class="h-28 animate-pulse rounded-2xl bg-white/10"></div>
        {/each}
      </div>
    {:else}
      {#if errorMsg}
        <div class="rounded-2xl border border-rose-400/50 bg-rose-500/10 p-4 text-rose-100">{errorMsg}</div>
      {:else}
        <!-- Saludo -->
        <section class="mb-6">
          <h1 class="text-2xl font-bold">
            Hola{user?.full_name ? `, ${user.full_name}` : ''} üëã
          </h1>
          <p class="text-white/70">
            {#if isAdmin()}
              Est√°s en el panel del administrador. Usa los accesos r√°pidos de abajo.
            {:else}
              Bienvenido a tu panel. Aqu√≠ ver√°s tus solicitudes y asignaciones recientes.
            {/if}
          </p>
        </section>

        {#if isAdmin()}
          <!-- Accesos r√°pidos de ADMIN -->
          <section class="mb-8 grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
            <a href="/admin" use:link class="card-btn">
              <div class="text-sm text-white/70">Administraci√≥n</div>
              <div class="mt-1 text-xl font-semibold">Panel principal</div>
              <p class="mt-2 text-sm text-white/70">Resumen y m√≥dulos.</p>
            </a>
            <a href="/admin/roles" use:link class="card-btn">
              <div class="text-sm text-white/70">Roles & Permisos</div>
              <div class="mt-1 text-xl font-semibold">Gestionar ACL</div>
              <p class="mt-2 text-sm text-white/70">Crear, editar, consultar, eliminar (soft-delete).</p>
            </a>
            <a href="/admin/usuarios" use:link class="card-btn">
              <div class="text-sm text-white/70">Usuarios</div>
              <div class="mt-1 text-xl font-semibold">CRUD de usuarios</div>
              <p class="mt-2 text-sm text-white/70">Con rol y ‚â•4 atributos.</p>
            </a>
            <a href="/principal" use:link class="card-btn">
              <div class="text-sm text-white/70">Presentaci√≥n</div>
              <div class="mt-1 text-xl font-semibold">P√°gina Principal</div>
              <p class="mt-2 text-sm text-white/70">Informaci√≥n del proyecto (requisito).</p>
            </a>
          </section>

          <!-- Atajo a Reporte (demo no funcional) -->
          <section class="mb-10">
            <div class="rounded-2xl border border-white/10 bg-white/10 p-5 flex items-center justify-between">
              <div>
                <h2 class="text-lg font-semibold">Reporte (demo)</h2>
                <p class="text-white/70 text-sm">Formulario + tabla sin backend (seg√∫n requisito del parcial).</p>
              </div>
              <a href="/reporte" use:link class="rounded-xl border border-white/20 bg-white/10 px-4 py-2 text-sm hover:bg-white/20">
                Abrir reporte
              </a>
            </div>
          </section>
        {/if}

        <!-- KPIs -->
        <section class="mb-8 grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
          <div class="rounded-2xl border border-white/10 bg-white/10 p-5">
            <div class="text-sm text-white/70">Solicitudes totales</div>
            <div class="mt-1 text-3xl font-semibold">{kpis.requestsTotal}</div>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/10 p-5">
            <div class="text-sm text-white/70">Asignaciones totales</div>
            <div class="mt-1 text-3xl font-semibold">{kpis.assignmentsTotal}</div>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/10 p-5">
            <div class="text-sm text-white/70">Usuario</div>
            <div class="mt-1 truncate text-xl">{user?.email}</div>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/10 p-5">
            <div class="text-sm text-white/70">Estado</div>
            <div class="mt-1 text-xl">{user?.is_active ? 'Activo' : 'Inactivo'}</div>
          </div>
        </section>

        <section class="grid gap-6 lg:grid-cols-2">
          <!-- √öltimas solicitudes -->
          <div class="overflow-hidden rounded-2xl border border-white/10 bg-white/10">
            <div class="flex items-center justify-between border-b border-white/10 p-4">
              <h2 class="text-lg font-semibold">√öltimas solicitudes</h2>
              <a href="/requests" use:link class="text-sm underline hover:opacity-80">Ver todas</a>
            </div>
            <div class="divide-y divide-white/10">
              {#if lastRequests.length === 0}
                <div class="p-4 text-white/70">Sin solicitudes recientes.</div>
              {:else}
                {#each lastRequests as r}
                  <div class="p-4">
                    <div class="flex items-center justify-between gap-4">
                      <div>
                        <div class="font-medium">{r?.service?.name ?? 'Servicio'}</div>
                        <div class="text-sm text-white/70">{r?.address ?? '‚Äî'}</div>
                      </div>
                      <div class="text-right">
                        <div class="text-sm">{r?.status ?? '‚Äî'}</div>
                        <div class="text-xs text-white/60">{fmtDate(r?.created_at)}</div>
                      </div>
                    </div>
                    {#if r?.description}
                      <p class="mt-2 line-clamp-2 text-sm text-white/80">{r.description}</p>
                    {/if}
                  </div>
                {/each}
              {/if}
            </div>
          </div>

          <!-- √öltimas asignaciones -->
          <div class="overflow-hidden rounded-2xl border border-white/10 bg-white/10">
            <div class="flex items-center justify-between border-b border-white/10 p-4">
              <h2 class="text-lg font-semibold">√öltimas asignaciones</h2>
              <a href="/assignments" use:link class="text-sm underline hover:opacity-80">Ver todas</a>
            </div>
            <div class="divide-y divide-white/10">
              {#if lastAssignments.length === 0}
                <div class="p-4 text-white/70">Sin asignaciones recientes.</div>
              {:else}
                {#each lastAssignments as a}
                  <div class="p-4">
                    <div class="flex items-center justify-between gap-4">
                      <div>
                        <div class="font-medium">#{a?.id ?? '‚Äî'} ¬∑ {a?.status ?? '‚Äî'}</div>
                        <div class="text-sm text-white/70">
                          T√©cnico: {a?.technician?.user?.full_name ?? a?.technician_id ?? '‚Äî'}
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-xs text-white/60">{fmtDate(a?.created_at)}</div>
                      </div>
                    </div>
                    {#if a?.notes}
                      <p class="mt-2 line-clamp-2 text-sm text-white/80">{a.notes}</p>
                    {/if}
                  </div>
                {/each}
              {/if}
            </div>
          </div>
        </section>
      {/if}
    {/if}
  </main>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .card-btn {
    display: block;
    border-radius: 1rem;
    border: 1px solid rgba(255,255,255,.1);
    background: rgba(255,255,255,.08);
    padding: 1.25rem;
    transition: transform .12s ease, background .12s ease, border .12s ease;
  }
  .card-btn:hover {
    transform: translateY(-2px);
    background: rgba(255,255,255,.12);
    border-color: rgba(255,255,255,.2);
  }
</style>
<section class="container">
  <h1>Administraci√≥n ¬∑ Usuarios</h1>
  <p>Pr√≥ximo: CRUD de usuarios con rol asignado y al menos 4 atributos.</p>
</section>

<style>.container{max-width:960px;margin:2rem auto;padding:1rem}</style>
<!-- src/pages/admin/AdminRoles.svelte -->
<script>
  import { link } from 'svelte-spa-router';
</script>

<div class="min-h-screen bg-slate-950 text-white/90">
  <main class="mx-auto max-w-5xl px-6 py-8">
    <nav class="mb-6 text-sm text-white/60">
      <a href="/admin" use:link class="underline hover:opacity-80">Administraci√≥n</a>
      <span class="mx-2">/</span>
      <span>Roles & Permisos</span>
    </nav>

    <!-- Lo solicitado -->
    <section class="container">
      <h1>Administraci√≥n ¬∑ Roles & Permisos</h1>
      <p>Pr√≥ximo: CRUD de roles con permisos por m√≥dulo (crear, leer, actualizar, eliminar/soft-delete).</p>
    </section>

    <!-- (Opcional) Tarjeta placeholder bonita, la puedes quitar si no la quieres -->
    <section class="mt-6 rounded-2xl border border-white/10 bg-white/10 p-5">
      <h2 class="text-lg font-semibold">Pr√≥ximos pasos</h2>
      <ul class="mt-2 list-disc space-y-1 pl-6 text-sm text-white/80">
        <li>Modelo/tabla: <code>rol</code>, <code>modulo</code>, <code>rol_modulo_permiso</code>.</li>
        <li>Endp. admin: crear/listar/editar/eliminar (soft-delete) roles y permisos.</li>
        <li>UI: tabla de roles, modal de edici√≥n de permisos por m√≥dulo (C/R/U/D).</li>
      </ul>
    </section>
  </main>
</div>

<style>
  .container{max-width:960px;margin:2rem auto;padding:1rem}
</style>
<!-- src/pages/admin/AdminRoles.svelte -->
<script>
  import { onMount } from "svelte";
  import { link } from "svelte-spa-router";

  /** =======================
   *  API m√≠nima (ajusta paths)
   *  =======================*/
  const API = import.meta.env.VITE_API_URL || "http://localhost:8000/api/v1";
  const authHeaders = () => {
    const t = localStorage.getItem("access_token");
    return t ? { Authorization: `Bearer ${t}` } : {};
  };
  const j = (r) => r.json();

  // Rutas sugeridas del backend (c√°mbialas si ya tienes otras)
  const ENDPOINTS = {
    roles: `${API}/acl/roles`,
    modules: `${API}/acl/modules`,
    rolePerms: (roleId) => `${API}/acl/roles/${roleId}/permissions`, // GET/PUT (bulk)
  };

  // Roles
  const fetchRoles = async () =>
    fetch(`${ENDPOINTS.roles}?include_inactive=true`, { headers: { ...authHeaders() } }).then(j);

  const createRole = async (payload) =>
    fetch(ENDPOINTS.roles, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(payload),
    }).then(j);

  const updateRole = async (id, payload) =>
    fetch(`${ENDPOINTS.roles}/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(payload),
    }).then(j);

  const softDeleteRole = async (id) =>
    fetch(`${ENDPOINTS.roles}/${id}`, {
      method: "DELETE",
      headers: { ...authHeaders() },
    });

  // M√≥dulos
  const fetchModules = async () =>
    fetch(`${ENDPOINTS.modules}?include_inactive=false`, { headers: { ...authHeaders() } }).then(j);

  // Permisos por rol (matriz)
  const fetchRolePerms = async (roleId) =>
    fetch(ENDPOINTS.rolePerms(roleId), { headers: { ...authHeaders() } }).then(j);

  const saveRolePerms = async (roleId, matrix) =>
    fetch(ENDPOINTS.rolePerms(roleId), {
      method: "PUT",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ permissions: matrix }), // [{modulo_id, can_create, can_read, can_update, can_delete}]
    }).then(j);

  /** =======================
   *  Estado UI
   *  =======================*/
  let loading = true;
  let errorMsg = "";
  let roles = []; // {id, nombre, descripcion, estado, created_at, ...}
  let modules = []; // {id, nombre, ruta, icono, estado}
  let showPerms = false;
  let showEdit = false;
  let editing = null; // rol que se est√° editando
  let form = { nombre: "", descripcion: "" };

  // Permisos en modal
  let selRole = null;
  let matrix = []; // [{modulo_id, nombre, can_create, can_read, can_update, can_delete}]

  const resetForm = () => (form = { nombre: "", descripcion: "" });

  const loadAll = async () => {
    loading = true; errorMsg = "";
    try {
      const [rRoles, rModules] = await Promise.all([fetchRoles(), fetchModules()]);
      roles = rRoles?.items ?? rRoles ?? [];
      modules = rModules?.items ?? rModules ?? [];
    } catch (e) {
      errorMsg = "No fue posible cargar Roles/M√≥dulos.";
      console.error(e);
    } finally {
      loading = false;
    }
  };

  onMount(loadAll);

  /** =======================
   *  Acciones Roles
   *  =======================*/
  const submitCreate = async () => {
    if (!form.nombre.trim()) return;
    const payload = { nombre: form.nombre.trim(), descripcion: form.descripcion?.trim() || null };
    const created = await createRole(payload);
    if (created?.id) {
      roles = [created, ...roles];
      resetForm();
    }
  };

  const startEdit = (r) => {
    editing = { ...r };
    showEdit = true;
  };

  const submitEdit = async () => {
    const { id, nombre, descripcion } = editing;
    const updated = await updateRole(id, { nombre, descripcion });
    if (updated?.id) {
      roles = roles.map((r) => (r.id === id ? updated : r));
      showEdit = false;
      editing = null;
    }
  };

  const toggleEstado = async (r) => {
    // Soft delete/restore
    const newEstado = r.estado === 1 ? 0 : 1;
    const updated = await updateRole(r.id, { estado: newEstado });
    if (updated?.id) {
      roles = roles.map((x) => (x.id === r.id ? updated : x));
    }
  };

  /** =======================
   *  Permisos (modal)
   *  =======================*/
  const openPerms = async (r) => {
    selRole = r;
    showPerms = true;
    matrix = [];
    try {
      // backend deber√≠a devolver array de objetos con permisos por m√≥dulo
      // Si viene vac√≠o, sembramos una base con todos los m√≥dulos en false.
      const current = await fetchRolePerms(r.id);
      const byId = new Map((current ?? []).map((p) => [p.modulo_id, p]));
      matrix = modules.map((m) => ({
        modulo_id: m.id,
        nombre: m.nombre,
        can_create: Boolean(byId.get(m.id)?.can_create),
        can_read: byId.has(m.id) ? Boolean(byId.get(m.id)?.can_read) : true, // por defecto true (lectura)
        can_update: Boolean(byId.get(m.id)?.can_update),
        can_delete: Boolean(byId.get(m.id)?.can_delete),
      }));
    } catch (e) {
      console.error(e);
    }
  };

  const toggle = (row, key) => (row[key] = !row[key]);

  const savePerms = async () => {
    const payload = matrix.map(({ modulo_id, can_create, can_read, can_update, can_delete }) => ({
      modulo_id, can_create, can_read, can_update, can_delete
    }));
    await saveRolePerms(selRole.id, payload);
    showPerms = false;
  };

  const fmtEstado = (e) => (e === 1 ? "Activo" : "Inactivo");
</script>

<div class="min-h-screen bg-slate-950 text-white/90">
  <main class="mx-auto max-w-7xl px-6 py-8">
    <nav class="mb-6 text-sm text-white/60">
      <a href="/admin" use:link class="underline hover:opacity-80">Administraci√≥n</a>
      <span class="mx-2">/</span>
      <span>Roles & Permisos</span>
    </nav>

    <!-- Encabezado -->
    <section class="container">
      <h1>Administraci√≥n ¬∑ Roles & Permisos</h1>
      <p>CRUD de roles y matriz de permisos por m√≥dulo (C/R/U/D con soft-delete).</p>
    </section>

    {#if loading}
      <div class="grid gap-4 md:grid-cols-3">
        {#each Array.from({ length: 6 }) as _}
          <div class="h-24 animate-pulse rounded-2xl bg-white/10"></div>
        {/each}
      </div>
    {:else}
      {#if errorMsg}
        <div class="rounded-2xl border border-rose-400/50 bg-rose-500/10 p-4 text-rose-100">{errorMsg}</div>
      {:else}
        <!-- Crear rol -->
        <section class="mb-6 rounded-2xl border border-white/10 bg-white/10 p-5">
          <h2 class="text-lg font-semibold">Crear nuevo rol</h2>
          <div class="mt-3 grid gap-3 md:grid-cols-3">
            <input
              class="rounded-xl border border-white/10 bg-slate-900/60 p-3 outline-none focus:ring"
              placeholder="Nombre del rol (√∫nico)"
              bind:value={form.nombre}
            />
            <input
              class="rounded-xl border border-white/10 bg-slate-900/60 p-3 outline-none focus:ring md:col-span-2"
              placeholder="Descripci√≥n (opcional)"
              bind:value={form.descripcion}
            />
          </div>
          <div class="mt-3">
            <button on:click={submitCreate}
              class="rounded-xl bg-emerald-500/90 px-4 py-2 font-semibold hover:bg-emerald-500">
              Crear rol
            </button>
          </div>
        </section>

        <!-- Tabla de roles -->
        <section class="overflow-hidden rounded-2xl border border-white/10 bg-white/10">
          <div class="flex items-center justify-between border-b border-white/10 p-4">
            <h2 class="text-lg font-semibold">Roles</h2>
            <span class="text-sm text-white/70">{roles.length} total</span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-white/5 text-left text-white/70">
                <tr>
                  <th class="px-4 py-3">ID</th>
                  <th class="px-4 py-3">Nombre</th>
                  <th class="px-4 py-3">Descripci√≥n</th>
                  <th class="px-4 py-3">Estado</th>
                  <th class="px-4 py-3 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/10">
                {#if roles.length === 0}
                  <tr><td colspan="5" class="px-4 py-6 text-center text-white/70">Sin roles.</td></tr>
                {:else}
                  {#each roles as r}
                    <tr>
                      <td class="px-4 py-3 font-mono text-white/80">#{r.id}</td>
                      <td class="px-4 py-3 font-medium">{r.nombre}</td>
                      <td class="px-4 py-3 text-white/80">{r.descripcion ?? "‚Äî"}</td>
                      <td class="px-4 py-3">
                       <td class="px-4 py-3">
  <span
    class={`rounded-full px-2 py-0.5 text-xs ${
      r.estado === 1
        ? "bg-emerald-500/20 text-emerald-300"
        : "bg-amber-500/20 text-amber-300"
    }`}
  >
    {fmtEstado(r.estado)}
  </span>
</td>

                      <td class="px-4 py-3">
                        <div class="flex items-center justify-end gap-2">
                          <button class="rounded-lg border border-white/10 bg-white/10 px-3 py-1 hover:bg-white/20"
                                  on:click={() => openPerms(r)}>
                            Permisos
                          </button>
                          <button class="rounded-lg border border-white/10 bg-white/10 px-3 py-1 hover:bg-white/20"
                                  on:click={() => startEdit(r)}>
                            Editar
                          </button>
                          <button class="rounded-lg border border-white/10 bg-white/10 px-3 py-1 hover:bg-white/20"
                                  on:click={() => toggleEstado(r)}>
                            {r.estado === 1 ? "Desactivar" : "Activar"}
                          </button>
                        </div>
                      </td>
                    </tr>
                  {/each}
                {/if}
              </tbody>
            </table>
          </div>
        </section>
      {/if}
    {/if}

    <!-- Modal editar rol -->
    {#if showEdit}
      <div class="fixed inset-0 z-40 grid place-items-center bg-black/60 p-4">
        <div class="w-full max-w-lg rounded-2xl border border-white/10 bg-slate-900 p-6">
          <h3 class="text-lg font-semibold">Editar rol</h3>
          <div class="mt-4 grid gap-3">
            <label class="text-sm">Nombre</label>
            <input class="rounded-xl border border-white/10 bg-slate-800 p-3" bind:value={editing.nombre} />
            <label class="mt-2 text-sm">Descripci√≥n</label>
            <input class="rounded-xl border border-white/10 bg-slate-800 p-3" bind:value={editing.descripcion} />
          </div>
          <div class="mt-6 flex justify-end gap-2">
            <button class="rounded-xl border border-white/10 bg-white/10 px-4 py-2 hover:bg-white/20"
                    on:click={() => { showEdit = false; editing = null; }}>
              Cancelar
            </button>
            <button class="rounded-xl bg-emerald-500 px-4 py-2 font-semibold hover:bg-emerald-600"
                    on:click={submitEdit}>
              Guardar cambios
            </button>
          </div>
        </div>
      </div>
    {/if}

    <!-- Modal permisos -->
    {#if showPerms}
      <div class="fixed inset-0 z-40 grid place-items-center bg-black/60 p-4">
        <div class="w-full max-w-4xl rounded-2xl border border-white/10 bg-slate-900 p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Permisos ¬∑ {selRole?.nombre}</h3>
            <button class="rounded-xl border border-white/10 bg-white/10 px-3 py-1 hover:bg-white/20"
                    on:click={() => (showPerms = false)}>
              Cerrar
            </button>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-white/5 text-left text-white/70">
                <tr>
                  <th class="px-4 py-3">M√≥dulo</th>
                  <th class="px-4 py-3 text-center">Crear</th>
                  <th class="px-4 py-3 text-center">Leer</th>
                  <th class="px-4 py-3 text-center">Actualizar</th>
                  <th class="px-4 py-3 text-center">Eliminar</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/10">
                {#each matrix as row, i}
                  <tr>
                    <td class="px-4 py-3 font-medium">{row.nombre}</td>
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" checked={row.can_create} on:change={() => toggle(row, "can_create")} />
                    </td>
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" checked={row.can_read} on:change={() => toggle(row, "can_read")} />
                    </td>
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" checked={row.can_update} on:change={() => toggle(row, "can_update")} />
                    </td>
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" checked={row.can_delete} on:change={() => toggle(row, "can_delete")} />
                    </td>
                  </tr>
                {/each}
              </tbody>
            </table>
          </div>

          <div class="mt-6 flex justify-end gap-2">
            <button class="rounded-xl border border-white/10 bg-white/10 px-4 py-2 hover:bg-white/20"
                    on:click={() => (showPerms = false)}>
              Cancelar
            </button>
            <button class="rounded-xl bg-emerald-500 px-4 py-2 font-semibold hover:bg-emerald-600"
                    on:click={savePerms}>
              Guardar permisos
            </button>
          </div>
        </div>
      </div>
    {/if}
  </main>
</div>

<style>
  .container{max-width:960px;margin:2rem auto;padding:1rem}
</style>
<script>
  import { location, push } from 'svelte-spa-router';
  import { onDestroy, onMount, createEventDispatcher } from 'svelte';
  import { session, isLoggedIn } from '../stores/auth.js';

  const dispatch = createEventDispatcher();

  export let brand = 'RIB';
  export let logoSrc = '/logo.png';
  export let links = {
    empresa: [
      { href: '/',           label: 'Inicio'     },
      { href: '/servicios',  label: 'Servicios'  },
      { href: '/precios',    label: 'Precios'    },
      { href: '/contacto',   label: 'Contacto'   },
    ],
    ayuda: [
      { href: '/faq',     label: 'FAQ'     },
      { href: '/soporte', label: 'Soporte' },
      { href: '/estado',  label: 'Estado'  },
    ],
    legal: [
      { href: '/privacidad', label: 'Privacidad' },
      { href: '/terminos',   label: 'T√©rminos'   },
    ]
  };

  // Estado desde stores
  $: logged = $isLoggedIn;
  $: userName = $session?.user?.full_name ?? $session?.user?.email ?? 'Invitado';

  let menuOpen = false;
  let accountOpen = false;

  // Detecta cambios de ruta para cerrar men√∫s
  let prevPath = '';
  const unsub = location.subscribe(($loc) => {
    if ($loc !== prevPath) {
      menuOpen = false;
      accountOpen = false;
      prevPath = $loc;
    }
  });
  onDestroy(() => unsub());

  // Ruta actual y helpers
  $: current = $location;
  const normalize = (p) => {
    if (!p) return '/';
    try { if (p.startsWith('http')) { const u = new URL(p); p = u.pathname + u.search + u.hash; } } catch {}
    p = p.replace(/^#\//, '/').replace(/#.*/, '').replace(/\?.*/, '');
    if (p.length > 1) p = p.replace(/\/+$/, '');
    return p || '/';
  };
  const isActive = (href) => {
    const a = normalize(current); const b = normalize(href);
    if (b === '/') return a === '/';
    return a === b || a.startsWith(b + '/');
  };

  // Detecta rutas de auth
  $: path = normalize(current);
  $: authRoute = path.startsWith('/login') || path.startsWith('/registro') || path.startsWith('/recuperar');

  function logout() { dispatch('logout'); accountOpen = false; }

  // Navegaci√≥n SPA
  const go = (href) => (e) => { e?.preventDefault?.(); push(href); };

  // --------- DETECCI√ìN DE PERFIL DE T√âCNICO (sin http.js) ----------
  const API_BASE_URL = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:8000/api/v1';

  function authHeaders() {
    try {
      const raw = localStorage.getItem('auth') ?? sessionStorage.getItem('auth');
      const token = raw ? JSON.parse(raw).access_token : null;
      const h = { 'Content-Type': 'application/json' };
      if (token) h.Authorization = `Bearer ${token}`;
      return h;
    } catch { return { 'Content-Type': 'application/json' }; }
  }

  let tech = null;          // objeto perfil si existe
  let techLoading = false;  // por si quieres mostrar loader alg√∫n d√≠a

  async function checkTechProfile() {
    if (!logged) { tech = null; return; }
    techLoading = true;
    try {
      const res = await fetch(`${API_BASE_URL}/technicians/me`, { headers: authHeaders() });
      if (res.status === 200) {
        const ct = res.headers.get('content-type') || '';
        tech = ct.includes('application/json') ? await res.json() : null;
      } else if (res.status === 404) {
        tech = null; // no tiene perfil a√∫n
      } else {
        tech = null; // otro error: lo tratamos como que no tiene
      }
    } catch {
      tech = null;
    } finally {
      techLoading = false;
    }
  }

  // Chequea al montar y cuando cambia el login o el usuario
  let lastUserId = null;
  onMount(() => { if (logged) checkTechProfile(); });
  $: if (logged && $session?.user?.id !== lastUserId) {
    lastUserId = $session?.user?.id ?? null;
    checkTechProfile();
  }
  $: if (!logged) { tech = null; lastUserId = null; }
</script>

<style>
  nav { position: sticky; top: 0; z-index: 50; background: #0b1220; color: #e5e7eb; }
  .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
  .brand { display:flex; align-items:center; gap:.5rem; font-weight:700; text-decoration:none; color:inherit; }
  .brand img { width: 32px; height: 32px; object-fit: contain; }
  .btn { padding:.5rem .75rem; border-radius:.5rem; text-decoration:none; display:inline-block; }
  .btn-ghost { color:#e5e7eb; }
  .btn-ghost:hover { background: rgba(255,255,255,.08); }
  .btn-primary { background:#6366f1; color:white; }
  .btn-primary:hover { filter:brightness(1.05); }
  .btn-outline { color:#e5e7eb; box-shadow: inset 0 0 0 1px rgba(255,255,255,.25); }
  .btn-outline:hover { background: rgba(255,255,255,.08); }
  .active { color:#a5b4fc; font-weight:700; position:relative; }
  .active::after { content:''; position:absolute; left:.5rem; right:.5rem; bottom:.35rem; height:2px; background:#a5b4fc; border-radius:2px; opacity:.9; }
  .section-title { font-size:.75rem; opacity:.6; margin:.75rem 0 .25rem; }
  .divider { height:1px; background:rgba(255,255,255,.08); margin:.5rem 0; }
  .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  .avatar { width: 28px; height: 28px; border-radius: 999px; background: #94a3b8; display:inline-grid; place-items:center; font-size:.75rem; font-weight:700; }
  .menu { position: absolute; right: 0; top: 100%; background: #0b1220; border: 1px solid rgba(255,255,255,.1); border-radius: .5rem; padding: .25rem; min-width: 180px; }
  .menu a, .menu button { display:block; width:100%; text-align:left; padding:.5rem .75rem; border-radius:.375rem; color:#e5e7eb; text-decoration:none; }
  .menu a:hover, .menu button:hover { background: rgba(255,255,255,.08); }
</style>

<nav class="shadow-soft">
  <div class="container">
    <div class="h-14 flex items-center justify-between">
      <!-- Brand -->
      <a href="/" class="brand" aria-label="Inicio" on:click={go('/')}>
        <img src={logoSrc} alt={brand} />
        <span>{brand}</span>
      </a>

      <!-- Desktop -->
      <div class="hidden md:flex items-center gap-1">
        {#if authRoute}
          <!-- En rutas de auth solo Inicio -->
          <a href="/" class="btn btn-ghost" class:active={isActive('/')} on:click={go('/')}>Inicio</a>

        {:else if logged}
          <!-- Nav LOGUEADO -->
          <a href="/dashboard"
             class="btn btn-ghost"
             class:active={isActive('/dashboard')}
             aria-current={isActive('/dashboard') ? 'page' : undefined}
             on:click={go('/dashboard')}>
            Dashboard
          </a>

          <a href="/solicitar" class="btn btn-primary ml-1" on:click={go('/solicitar')}>Pedir t√©cnico</a>

          {#if tech}
            <!-- Tiene perfil de t√©cnico -->
            <a href="/mis-trabajos" class="btn btn-ghost" class:active={isActive('/mis-trabajos')} on:click={go('/mis-trabajos')}>Mis trabajos</a>
            <a href="/perfil-tecnico" class="btn btn-ghost" class:active={isActive('/perfil-tecnico')} on:click={go('/perfil-tecnico')}>Perfil t√©cnico</a>
          {:else}
            <!-- NO tiene perfil todav√≠a -->
            <a href="/soy-tecnico" class="btn btn-outline ml-1" on:click={go('/soy-tecnico')}>Quiero ser tecnico</a>
          {/if}

          <div class="relative ml-2">
            <button class="btn btn-outline flex items-center"
                    aria-haspopup="menu" aria-expanded={accountOpen}
                    on:click={() => (accountOpen = !accountOpen)}>
              <span class="avatar">{userName?.[0]?.toUpperCase() || 'U'}</span>
              <span class="ml-2 truncate max-w-[12rem]">{userName}</span>
            </button>
            {#if accountOpen}
              <div class="menu mt-2">
                <a href="/cuenta" on:click={go('/cuenta')}>Mi cuenta</a>
                {#if tech}
                  <a href="/perfil-tecnico" on:click={go('/perfil-tecnico')}>Perfil t√©cnico</a>
                {:else}
                  <a href="/soy-tecnico" on:click={go('/soy-tecnico')}>Quiero ser t√©cnico</a>
                {/if}
                <button on:click={logout}>Cerrar sesi√≥n</button>
              </div>
            {/if}
          </div>

        {:else}
          <!-- Nav NO LOGUEADO -->
          {#each links.empresa as item}
            <a href={item.href}
               class="btn btn-ghost"
               class:active={isActive(item.href)}
               aria-current={isActive(item.href) ? 'page' : undefined}
               on:click={go(item.href)}>
              {item.label}
            </a>
          {/each}
          <div class="mx-2 opacity-30">|</div>
          {#each links.ayuda as item}
            <a href={item.href}
               class="btn btn-ghost"
               class:active={isActive(item.href)}
               aria-current={isActive(item.href) ? 'page' : undefined}
               on:click={go(item.href)}>
              {item.label}
            </a>
          {/each}
          <div class="mx-2 opacity-30">|</div>
          {#each links.legal as item}
            <a href={item.href}
               class="btn btn-ghost"
               class:active={isActive(item.href)}
               aria-current={isActive(item.href) ? 'page' : undefined}
               on:click={go(item.href)}>
              {item.label}
            </a>
          {/each}
          <a href="/login" class="btn btn-outline ml-2" on:click={go('/login')}>Iniciar sesi√≥n</a>
          <a href="/registro" class="btn btn-primary ml-2" on:click={go('/registro')}>Registrarse</a>
        {/if}
      </div>

      <!-- Mobile toggle -->
      <button aria-label="Abrir men√∫" class="md:hidden btn btn-ghost" on:click={() => (menuOpen = !menuOpen)}>
        {#if menuOpen} ‚úï {:else} ‚ò∞ {/if}
      </button>
    </div>
  </div>

  <!-- Mobile -->
  {#if menuOpen}
    <div class="md:hidden">
      <div class="container pb-3">
        {#if authRoute}
          <div class="grid grid-cols-1 gap-2">
            <a href="/" class="btn btn-ghost" class:active={isActive('/')} on:click={go('/')}>Inicio</a>
          </div>

        {:else if logged}
          <div class="grid grid-cols-1 gap-2">
            <a href="/dashboard" class="btn btn-ghost" class:active={isActive('/dashboard')} on:click={go('/dashboard')}>Dashboard</a>
            <a href="/solicitar" class="btn btn-primary" on:click={go('/solicitar')}>Pedir t√©cnico</a>
            {#if tech}
              <a href="/mis-trabajos" class="btn btn-ghost" class:active={isActive('/mis-trabajos')} on:click={go('/mis-trabajos')}>Mis trabajos</a>
              <a href="/perfil-tecnico" class="btn btn-ghost" class:active={isActive('/perfil-tecnico')} on:click={go('/perfil-tecnico')}>Perfil t√©cnico</a>
            {:else}
              <a href="/soy-tecnico" class="btn btn-outline" on:click={go('/soy-tecnico')}>Soy t√©cnico</a>
            {/if}
            <a href="/cuenta" class="btn btn-ghost" on:click={go('/cuenta')}>Mi cuenta</a>
            <button class="btn btn-ghost" on:click={logout}>Cerrar sesi√≥n</button>
          </div>

        {:else}
          <div class="section-title">Empresa</div>
          <div class="grid grid-cols-2 gap-2">
            {#each links.empresa as item}
              <a href={item.href} class="btn btn-ghost" class:active={isActive(item.href)} on:click={go(item.href)}>{item.label}</a>
            {/each}
          </div>
          <div class="divider" />
          <div class="section-title">Ayuda</div>
          <div class="grid grid-cols-2 gap-2">
            {#each links.ayuda as item}
              <a href={item.href} class="btn btn-ghost" class:active={isActive(item.href)} on:click={go(item.href)}>{item.label}</a>
            {/each}
          </div>
          <div class="divider" />
          <div class="section-title">Legal</div>
          <div class="grid grid-cols-2 gap-2">
            {#each links.legal as item}
              <a href={item.href} class="btn btn-ghost" class:active={isActive(item.href)} on:click={go(item.href)}>{item.label}</a>
            {/each}
          </div>
          <div class="grid grid-cols-1 gap-2 mt-2">
            <a href="/login" class="btn btn-ghost" on:click={go('/login')}>Iniciar sesi√≥n</a>
            <a href="/registro" class="btn btn-primary" on:click={go('/registro')}>Registrarse</a>
          </div>
        {/if}
      </div>
    </div>
  {/if}
</nav>
<script>
  import { onMount } from 'svelte';
  import { link, push } from 'svelte-spa-router';
  import { clearAuth } from '../api/auth.js';

  let loggedIn = false;

  function readAuth() {
    try {
      const raw = localStorage.getItem('auth') ?? sessionStorage.getItem('auth');
      const tok = raw ? JSON.parse(raw) : null;
      loggedIn = Boolean(tok?.access_token);
    } catch {
      loggedIn = false;
    }
  }

  function logout() {
    clearAuth();
    readAuth();
    push('/login');
  }

  onMount(() => {
    readAuth();
    // refresca este header si otro tab cambia el token
    const onStorage = (e) => {
      if (e.key === 'auth') readAuth();
    };
    window.addEventListener('storage', onStorage);
    return () => window.removeEventListener('storage', onStorage);
  });
</script>

<header class="sticky top-0 z-20 border-b border-white/10 bg-slate-900/70 backdrop-blur">
  <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-3 text-white/90">
    <a href="/" use:link class="flex items-center gap-2">
      <img src="/logo.png" alt="RIB" class="h-8 w-8 rounded-lg ring-1 ring-white/15 object-cover" />
      <span class="font-semibold">RIB</span>
    </a>

    <nav class="flex items-center gap-4 text-sm">
      <a href="/" use:link class="rounded px-2 py-1 hover:bg-white/10">Inicio</a>
      <a href="/servicios" use:link class="rounded px-2 py-1 hover:bg-white/10">Servicios</a>
      <a href="/precios" use:link class="rounded px-2 py-1 hover:bg-white/10">Precios</a>
      <a href="/contacto" use:link class="rounded px-2 py-1 hover:bg-white/10">Contacto</a>
      <span class="opacity-40">|</span>

      {#if loggedIn}
        <a href="/dashboard" use:link class="rounded px-2 py-1 hover:bg-white/10">Dashboard</a>
        <!-- üëá Bot√≥n para pedir t√©cnico -->
        <a href="/solicitar" use:link class="rounded bg-indigo-600 px-3 py-1 hover:brightness-110">Pedir t√©cnico</a>
        <button class="rounded bg-white/10 px-3 py-1 hover:bg-white/20" on:click={logout}>Salir</button>
      {:else}
        <a href="/login" use:link class="rounded px-2 py-1 hover:bg-white/10">Iniciar sesi√≥n</a>
        <a href="/registro" use:link class="rounded bg-indigo-600 px-3 py-1 hover:brightness-110">Registrarse</a>
      {/if}
    </nav>
  </div>
</header>
<script>
  import MapLeaflet from '../pages/MapLeaflet.svelte';
  import { chipFor, timeAgo, fmtDate, money, getLat, getLng, I } from '../utils/formatters.js';
  export let r;
  export let onView;          // () => void
  export let onRequestTech;   // () => void
  export let creatingFor;     // number | null
</script>

<style>
  /* mismos estilos clave que AssignmentCard */
  .card{border:1px solid var(--line);background:linear-gradient(180deg,rgba(16,24,40,.85),rgba(15,23,42,.92));border-radius:16px;padding:16px;color:#e5e7eb;box-shadow:0 6px 24px rgba(2,6,23,.35)}
  .head{display:flex;gap:12px;align-items:center}
  .ico{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:#111827;border:1px solid var(--line);color:#93c5fd}
  .service{font-weight:700}
  .meta{color:#b6c1d4;font-size:12px}
  .pills{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
  .pill{display:flex;align-items:center;gap:6px;padding:.45rem .7rem;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#cbd5e1;font-size:13px}
  .btn{padding:.6rem 1rem;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#0b1220;border:1px solid var(--line);color:#dbe3f2}
  .btn.ghost{background:transparent;border:1px dashed var(--line);color:#9fb7ff;margin-left:8px}
  .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .block{display:grid;gap:6px;margin:8px 0}
  .muted{color:#9aa3b2;font-size:13px}
  .timeline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:999px;background:#334155}
  .step{display:flex;align-items:center;gap:6px;color:#a7b1c6}
  .step.active .dot{background:#60a5fa;box-shadow:0 0 0 4px rgba(96,165,250,.15)}
  :global(.leaflet-container){height:220px;border-radius:12px}
  .line{height:1px;background:var(--line);opacity:.6;margin:8px 0}
  .chip{padding:.25rem .6rem;border-radius:999px;font:700 12px/1 ui-sans-serif;border:1px solid #1f2937;background:#101826;color:#e5e7eb}
.chip--ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok)}
  .miniMap{width:100%;aspect-ratio:16/9;border-radius:12px;border:1px solid var(--line);background:#0b1220;display:grid;place-items:center;color:#93c5fd}
</style>

<div class="card">
  <div class="head">
    <div class="ico" aria-hidden="true">{@html I.service}</div>
    <div>
      <div class="service">{r?.title ?? r?.service?.name ?? r?.service_name ?? 'Servicio'}</div>
      <div class="meta">Solicitud #{r?.id ?? r?.request_id ?? '‚Äî'} ‚Ä¢ {timeAgo(r?.updated_at ?? r?.updatedAt)}</div>
    </div>
    <div style="margin-left:auto">
      <span class="{chipFor(r?.status).cls}">{chipFor(r?.status).text}</span>
    </div>
  </div>

  <div class="pills">
    <div class="pill"><span aria-hidden="true">{@html I.pin}</span>{r?.city ?? r?.location ?? r?.address ?? 'Ubicaci√≥n no especificada'}</div>
    <div class="pill"><span aria-hidden="true">{@html I.clock}</span>{r?.scheduled_for ? fmtDate(r.scheduled_for) : 'Sin programar'}</div>
    <div class="pill"><span aria-hidden="true">{@html I.money}</span>{money(r?.budget)}</div>
  </div>

  <div class="ctaRow">
    <button class="btn" on:click={onView}>Ver detalle</button>
    <button class="btn ghost" disabled={creatingFor===(r?.id ?? r?.request_id)} on:click={onRequestTech}>
      {creatingFor===(r?.id ?? r?.request_id) ? 'Solicitando‚Ä¶' : 'Solicitar t√©cnico'}
    </button>
  </div>

  <details>
    <summary>Detalles</summary>

    <div class="block">
      <h5>Resumen del servicio</h5>
      <div class="muted">{r?.description || 'Sin descripci√≥n proporcionada.'}</div>
    </div>

    <div class="block">
      <h5>Cliente</h5>
      <div class="muted">{r?.customer?.full_name ?? 'Cliente'} ¬∑ {r?.customer?.phone ?? '‚Äî'}</div>
    </div>

    <div class="block">
      <h5>Ubicaci√≥n</h5>
      {#if getLat(r) != null && getLng(r) != null}
        {#key (r?.id ?? r?.request_id)}
          <MapLeaflet lat={getLat(r)} lng={getLng(r)} zoom={15} editable={false} height="220px" />
        {/key}
      {:else}
        <div class="miniMap">Sin coordenadas ‚Äî {r?.address ?? r?.city ?? '‚Äî'}</div>
      {/if}
      <div class="muted">{r?.address ?? r?.city ?? '‚Äî'}</div>
    </div>

    <div class="block">
      <h5>Estado del proceso</h5>
      <div class="timeline">
        <div class="step {['creada','pending','nuevo','created'].includes((r?.status||'').toLowerCase()) ? 'active' : ''}">
          <span class="dot"></span><span>Creada</span>
        </div>
        <div class="step {['assigned','en_proceso','in_process','aceptada'].includes((r?.status||'').toLowerCase()) ? 'active' : ''}">
          <span class="dot"></span><span>En proceso</span>
        </div>
        <div class="step {['finished','finalizada','done','completado'].includes((r?.status||'').toLowerCase()) ? 'active' : ''}">
          <span class="dot"></span><span>Finalizada</span>
        </div>
      </div>
    </div>

    <div class="line"></div>
    <div class="muted">Actualizado {timeAgo(r?.updated_at ?? r?.updatedAt)} ¬∑ Creado {fmtDate(r?.created_at ?? r?.createdAt)}</div>
  </details>
</div>
<script>
  import MapLeaflet from '../pages/MapLeaflet.svelte';
  import { chipFor, timeAgo, fmtDate, money, getLat, getLng, I } from '../utils/formatters.js';
  export let a;
  export let onView;         // () => void
  export let onAccept;       // () => void
  export let onFinish;       // () => void
  export let switchingId;    // number | null
</script>

<style>
  .card{border:1px solid var(--line);background:linear-gradient(180deg,rgba(16,24,40,.85),rgba(15,23,42,.92));border-radius:16px;padding:16px;color:#e5e7eb;box-shadow:0 6px 24px rgba(2,6,23,.35)}
  .head{display:flex;gap:12px;align-items:center}
  .ico{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:#111827;border:1px solid var(--line);color:#93c5fd}
  .service{font-weight:700}
  .meta{color:#b6c1d4;font-size:12px}
  .pills{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
  .pill{display:flex;align-items:center;gap:6px;padding:.45rem .7rem;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#cbd5e1;font-size:13px}
  .btn{padding:.6rem 1rem;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#0b1220;border:1px solid var(--line);color:#dbe3f2}
  .btn.ghost{background:transparent;border:1px dashed var(--line);color:#9fb7ff;margin-left:8px}
  .ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .block{display:grid;gap:6px;margin:8px 0}
  .muted{color:#9aa3b2;font-size:13px}
  .timeline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:999px;background:#334155}
  .step{display:flex;align-items:center;gap:6px;color:#a7b1c6}
  .step.active .dot{background:#60a5fa;box-shadow:0 0 0 4px rgba(96,165,250,.15)}
  :global(.leaflet-container){height:220px;border-radius:12px}
  .line{height:1px;background:var(--line);opacity:.6;margin:8px 0}
  .chip{padding:.25rem .6rem;border-radius:999px;font:700 12px/1 ui-sans-serif;border:1px solid #1f2937;background:#101826;color:#e5e7eb}
  .chip--ok{background:var(--ok-bg);border-color:var(--ok-br);color:var(--ok)}
  .chip--warn{background:var(--warn-bg);border-color:var(--warn-br);color:var(--warn)}
  .chip--info{background:var(--info-bg);border-color:var(--info-br);color:var(--info)}
  .chip--bad{background:var(--bad-bg);border-color:var(--bad-br);color:var(--bad)}
  .miniMap{width:100%;aspect-ratio:16/9;border-radius:12px;border:1px solid var(--line);background:#0b1220;display:grid;place-items:center;color:#93c5fd}
</style>

<div class="card">
  <div class="head">
    <div class="ico" aria-hidden="true">{@html I.service}</div>
    <div>
      <div class="service">{a?.service?.name ?? a?.service_name ?? 'Servicio'}</div>
      <div class="meta">Asignaci√≥n #{a?.id ?? a?.assignment_id ?? '‚Äî'} ‚Ä¢ {timeAgo(a?.updated_at ?? a?.updatedAt)}</div>
    </div>
    <div style="margin-left:auto">
      <span class="{chipFor(a?.status).cls}">{chipFor(a?.status).text}</span>
    </div>
  </div>

  <div class="pills">
    <div class="pill"><span aria-hidden="true">{@html I.pin}</span>{a?.city ?? a?.location ?? a?.address ?? 'Ubicaci√≥n no especificada'}</div>
    <div class="pill"><span aria-hidden="true">{@html I.clock}</span>{a?.scheduled_for ? fmtDate(a.scheduled_for) : 'Sin programar'}</div>
    <div class="pill"><span aria-hidden="true">{@html I.money}</span>{money(a?.budget)}</div>
  </div>

  <div class="ctaRow">
    <button class="btn secondary" on:click={onView}>Ver detalle</button>
    {#if (a?.status ?? '').toLowerCase() === 'pending'}
      <button class="btn ghost" disabled={switchingId===(a?.id ?? a?.assignment_id)} on:click={onAccept}>
        {switchingId===(a?.id ?? a?.assignment_id) ? 'Aceptando‚Ä¶' : 'Aceptar trabajo'}
      </button>
    {/if}
    {#if ['in_process','en_proceso','assigned'].includes((a?.status||'').toLowerCase())}
      <button class="btn ghost" disabled={switchingId===(a?.id ?? a?.assignment_id)} on:click={onFinish}>
        {switchingId===(a?.id ?? a?.assignment_id) ? 'Finalizando‚Ä¶' : 'Finalizar'}
      </button>
    {/if}
  </div>

  <details>
    <summary>Detalles</summary>

    <div class="block">
      <h5>Resumen del servicio</h5>
      <div class="muted">{a?.description || 'Sin descripci√≥n proporcionada.'}</div>
    </div>

    <div class="block">
      <h5>Cliente</h5>
      <div class="muted">{a?.customer?.full_name ?? 'Cliente'} ¬∑ {a?.customer?.phone ?? '‚Äî'}</div>
    </div>

    <div class="block">
      <h5>Ubicaci√≥n</h5>
      {#if getLat(a) != null && getLng(a) != null}
        {#key (a?.id ?? a?.assignment_id)}
          <MapLeaflet lat={getLat(a)} lng={getLng(a)} zoom={15} editable={false} height="220px" />
        {/key}
      {:else}
        <div class="miniMap">Sin coordenadas ‚Äî {a?.address ?? a?.city ?? '‚Äî'}</div>
      {/if}
      <div class="muted">{a?.address ?? a?.city ?? '‚Äî'}</div>
    </div>

    <div class="block">
      <h5>Estado del proceso</h5>
      <div class="timeline">
        <div class="step {['creada','pending','nuevo','created'].includes((a?.status||'').toLowerCase()) ? 'active' : ''}">
          <span class="dot"></span><span>Creada</span>
        </div>
        <div class="step {['assigned','en_proceso','in_process','aceptada'].includes((a?.status||'').toLowerCase()) ? 'active' : ''}">
          <span class="dot"></span><span>En proceso</span>
        </div>
        <div class="step {['finished','finalizada','done','completado'].includes((a?.status||'').toLowerCase()) ? 'active' : ''}">
          <span class="dot"></span><span>Finalizada</span>
        </div>
      </div>
    </div>

    <div class="line"></div>
    <div class="muted">Actualizado {timeAgo(a?.updated_at ?? a?.updatedAt)} ¬∑ Creado {fmtDate(a?.created_at ?? a?.createdAt)}</div>
  </details>
</div>
// api/technicians.js
const API_BASE_URL =
  import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:8000/api/v1';

// ---------- helpers ----------
function getToken() {
  try {
    const raw = localStorage.getItem('auth') ?? sessionStorage.getItem('auth');
    return raw ? JSON.parse(raw).access_token : null;
  } catch {
    return null;
  }
}

function buildUrl(path) {
  return /^https?:\/\//i.test(path)
    ? path
    : `${API_BASE_URL}${path.startsWith('/') ? path : `/${path}`}`;
}

async function authedFetch(path, options = {}) {
  const token = getToken();
  const headers = new Headers(options.headers || {});

  // Acepta JSON, texto o binario en respuesta
  if (!headers.has('Accept')) {
    headers.set('Accept', 'application/json, text/plain;q=0.9, */*;q=0.8');
  }
  if (token) {
    headers.set('Authorization', `Bearer ${token}`);
  }

  // Cuerpo: soporta options.json, options.formData o options.body
  let body = options.body;

  if (options.json !== undefined) {
    if (!headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
    body = JSON.stringify(options.json);
  } else if (options.formData instanceof FormData) {
    // ¬°No setear Content-Type para FormData!
    body = options.formData;
  } else if (
    body &&
    !(body instanceof FormData) &&
    typeof body !== 'string' &&
    !headers.has('Content-Type')
  ) {
    headers.set('Content-Type', 'application/json');
    body = JSON.stringify(body);
  }

  const response = await fetch(buildUrl(path), {
    redirect: 'follow',
    ...options,
    headers,
    body,
  });

  // Parse tolerante
  let data = null;
  try {
    if (response.status !== 204) {
      const ct = response.headers.get('content-type') || '';
      data = ct.includes('application/json') ? await response.json() : await response.text();
    }
  } catch { /* ignore */ }

  return { response, data };
}

// ---------- PERFIL ----------
export function getMyTechnicianProfile() {
  return authedFetch('/technicians/me');
}

export function applyTechnician(payload) {
  return authedFetch('/technicians/apply', { method: 'POST', json: payload });
}

export function updateMyTechnicianProfile(payload) {
  return authedFetch('/technicians/me', { method: 'PATCH', json: payload });
}

// ---------- DOCUMENTOS DEL T√âCNICO ----------
export function listTechnicianDocuments() {
  return authedFetch('/technicians/me/documents');
}

export function uploadTechnicianDocument(file, meta = {}) {
  const form = new FormData();
  form.append('file', file); // el backend espera "file"
  if (meta.kind)       form.append('kind', meta.kind);
  if (meta.issuer)     form.append('issuer', meta.issuer);
  if (meta.issued_at)  form.append('issued_at', meta.issued_at);     // yyyy-mm-dd
  if (meta.expires_at) form.append('expires_at', meta.expires_at);   // yyyy-mm-dd
  if (meta.notes)      form.append('notes', meta.notes);

  return authedFetch('/technicians/me/documents', {
    method: 'POST',
    formData: form,
  });
}

export function deleteTechnicianDocument(docId) {
  return authedFetch(`/technicians/me/documents/${docId}`, { method: 'DELETE' });
}

// ---------- MIS TRABAJOS (evita 307 usando slash final) ----------
export function listAssignments({ page = 1, size = 5 } = {}) {
  return authedFetch(`/assignments/?page=${page}&size=${size}`);
}

export function listRequests({ page = 1, size = 5 } = {}) {
  return authedFetch(`/requests/?page=${page}&size=${size}`);
}
// src/lib/api/requests.js
import { authedFetch } from './auth.js';

/** Lista de servicios (para el <select>). */
export async function listServices({ page = 1, size = 100 } = {}) {
  return authedFetch(`/services/?page=${page}&size=${size}`);
}

/** Lista de solicitudes del usuario (paginado). */
export async function listRequests({ page = 1, size = 10 } = {}) {
  return authedFetch(`/requests/?page=${page}&size=${size}`);
}

/** Crear una solicitud de servicio. */
export async function createRequest(payload) {
  return authedFetch('/requests', {
    method: 'POST',
    json: payload,
  });
}

/** Detalle de una solicitud por ID (nombre que espera tu vista). */
export async function getRequestById(request_id) {
  return authedFetch(`/requests/${request_id}`);
}

/** Alias por si en alg√∫n sitio usaste getRequest. */
export const getRequest = getRequestById;

/** Cancelar una solicitud. */
export async function cancelRequest(id) {
  return authedFetch(`/requests/${id}`, {
    method: 'PATCH',
    json: { status: 'cancelled' },
  });
}

/** T√©cnicos cercanos (requiere token). */
export async function nearbyTechnicians({ latitude, longitude, radius_km = 10 }) {
  const qs = new URLSearchParams({
    lat: String(latitude),
    lng: String(longitude),
    radius_km: String(radius_km),
  }).toString();
  return authedFetch(`/technicians/nearby?${qs}`);
}
// src/api/dashboard.js
import { authedFetch } from './auth';

// Normaliza respuestas tipo {items,total} o arrays planos
function unwrapList(payload) {
  if (!payload) return { items: [], total: 0 };
  if (Array.isArray(payload)) return { items: payload, total: payload.length };
  const items = payload.items ?? payload.data ?? [];
  const total = payload.total ?? payload.count ?? items.length ?? 0;
  return { items, total };
}

// Solicitudes del usuario (paginadas)
export async function fetchRequests({ size = 5, page = 1 } = {}) {
  const { response, data } = await authedFetch(`/requests?page=${page}&size=${size}`);
  return { response, ...unwrapList(data) };
}

// Asignaciones (si el usuario no es t√©cnico/superuser puede responder 403)
export async function fetchAssignments({ size = 5, page = 1 } = {}) {
  const { response, data } = await authedFetch(`/assignments?page=${page}&size=${size}`);
  return { response, ...unwrapList(data) };
}

// Servicios activos para el selector
export async function listServices({ page = 1, size = 100 } = {}) {
  const { response, data } = await authedFetch(`/services?page=${page}&size=${size}`);
  return { response, ...unwrapList(data) };
}

// Crear una solicitud de servicio
export async function createRequest(payload) {
  const { response, data } = await authedFetch(`/requests`, {
    method: 'POST',
    body: JSON.stringify(payload),
  });
  return { response, data };
}
// src/api/auth.js
export const API_BASE_URL =
  import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:8000/api/v1';

const STORAGE_KEY = 'auth';

// ----------------- helpers base -----------------
function buildUrl(path) {
  return /^https?:\/\//i.test(path)
    ? path
    : `${API_BASE_URL}${path.startsWith('/') ? path : `/${path}`}`;
}

// ----------------- auth endpoints -----------------
export async function login(email, password) {
  const response = await fetch(buildUrl('/auth/login'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  let data = null; try { data = await response.json(); } catch {}
  return { response, data };
}

export async function register({ email, password, full_name, phone_number }) {
  const response = await fetch(buildUrl('/auth/register'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password, full_name, phone_number })
  });
  let data = null; try { data = await response.json(); } catch {}
  return { response, data };
}

// ----------------- session storage -----------------
export function getAuth() {
  const raw = localStorage.getItem(STORAGE_KEY) || sessionStorage.getItem(STORAGE_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

export function setAuth(data, remember = true) {
  const tgt = remember ? localStorage : sessionStorage;
  const other = remember ? sessionStorage : localStorage;
  try { other.removeItem(STORAGE_KEY); } catch {}
  tgt.setItem(STORAGE_KEY, JSON.stringify(data));
}

export function clearAuth() {
  try {
    localStorage.removeItem(STORAGE_KEY);
    sessionStorage.removeItem(STORAGE_KEY);
  } catch {}
}

// ----------------- fetch con bearer & parse tolerante -----------------
// Soporta: { json }, { formData }, o { body } crudo.
// No fuerza Content-Type cuando es FormData (para uploads).
export async function authedFetch(path, options = {}) {
  const auth = getAuth();
  const headers = new Headers(options.headers || {});
  if (!headers.has('Accept')) {
    headers.set('Accept', 'application/json, text/plain;q=0.9, */*;q=0.8');
  }
  if (auth?.access_token) {
    headers.set('Authorization', `Bearer ${auth.access_token}`);
  }

  let body = options.body;

  if (options.json !== undefined) {
    if (!headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
    body = JSON.stringify(options.json);
  } else if (options.formData instanceof FormData) {
    // no seteamos Content-Type (el navegador pone boundary)
    body = options.formData;
  } else if (
    body &&
    !(body instanceof FormData) &&
    typeof body !== 'string' &&
    !headers.has('Content-Type')
  ) {
    headers.set('Content-Type', 'application/json');
    body = JSON.stringify(body);
  }

  const response = await fetch(buildUrl(path), {
    redirect: 'follow',
    ...options,
    headers,
    body
  });

  // Parseo seguro
  let data = null;
  try {
    if (response.status !== 204) {
      const ct = response.headers.get('content-type') || '';
      data = ct.includes('application/json') ? await response.json() : await response.text();
    }
  } catch { /* ignore */ }

  if (response.status === 401) {
    clearAuth();
  }

  return { response, data };
}

export async function me() {
  return authedFetch('/users/me');
}
// src/api/assignments.js
import { authedFetch } from './auth.js';

// Crea una asignaci√≥n para una solicitud dada (request_id)
export async function createAssignment(request_id) {
  return authedFetch('/assignments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ request_id }),
  });
}

// Cambia estado de una asignaci√≥n (p.ej. "in_process", "finished", "cancelled")
export async function setAssignmentStatus(assignment_id, status) {
  return authedFetch(`/assignments/${assignment_id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status }),
  });
}

// Obtiene detalle de una asignaci√≥n
export async function getAssignment(assignment_id) {
  return authedFetch(`/assignments/${assignment_id}`);
}
